<dom-module id="nuxeo-opportunity-view-layout">
  <template>
    <style>
      *[role=widget] {
        padding: 5px;
      }
      .results {
        @apply(--layout-vertical);
        @apply(--layout-flex);
        min-height: calc(112vh - 14em);
        margin-top: 8px;
      }
      nuxeo-data-grid {
        display: block;
        position: relative;
      }
    </style>
    <nuxeo-connection id="nxcon"></nuxeo-connection>
    <paper-card role="widget">

      <h3>
        Activities
      </h3>

      <div class="dataTable">
        <nuxeo-page-provider
                             role="widget"
                             id="interactionProvider"
                             auto
                             query="SELECT * FROM Interaction WHERE ecm:currentLifeCycleState != 'deleted' and ecm:parentId = '[[document.uid]]' ORDER BY interaction:date DESC"
                             page-size="5"
                             params="[[params]]"
                             aggregations="{{interactionAggregations}}"
                             current-page="{{interactions}}">
        </nuxeo-page-provider>

        <template is="dom-repeat" items="[[interactions]]">
          <div>[[_formatDate(item.properties.interaction:date)]]</div>
          <div><a href$="#!/browse[[item.path]]">[[formatDirectory(item.properties.interaction:activity)]] - [[item.title]]</a></div>
          <div>[[item.properties.dc:description]]</div>
          <br/>
        </template>

      <h3>
        Attachments
      </h3>
      <div class="dataTable">
        <nuxeo-page-provider id="nxProvider" auto
                             query="select * from Document where ecm:mixinType != 'HiddenInNavigation' AND ecm:isCheckedInVersion = 0 AND ecm:primaryType in ('File', 'Folder') and ecm:currentLifeCycleState != 'deleted' and ecm:parentId = '[[document.uid]]' ORDER BY dc:title ASC"
                             page-size="40"
                             aggregations="{{aggregations}}"
                             enrichers="thumbnail, permissions"
                             page="[[pageNumber]]"
                             params="[[params]]"
                             schemas="dublincore,common,uid,file"
                             headers='{"X-NXfetch.document": "properties", "X-NXtranslate.directoryEntry": "label"}'
                             fetch-aggregates>
        </nuxeo-page-provider>

        <nuxeo-results name="[[document.uid]]" nx-provider="[[nxProvider]]" selected-items="{{selectedItems}}">
          <div class="selectionActions">
            <nuxeo-slot slot="BROWSE_ACTIONS" model="[[browseActionContext]]"></nuxeo-slot>
          </div>

          <!-- Grid view -->
          <nuxeo-data-grid class="results" name="grid" icon="nuxeo:view-thumbnails"
                           empty-label="[[emptyLabel]]"
                           empty-label-when-filtered="[[emptyLabelWhenFiltered]]"
                           selection-enabled display-quick-filters>
            <template>
              <nuxeo-document-grid-thumbnail class="grid-box"
                                             tabindex$="{{tabIndex}}"
                                             selected$="{{selected}}"
                                             doc="[[item]]" on-navigate="_navigate"
                                             selected-items="[[selectedItems]]">
              </nuxeo-document-grid-thumbnail>
            </template>
          </nuxeo-data-grid>

          <!-- Table view -->
          <nuxeo-data-table class="results" name="table" icon="nuxeo:view-list"
                            settings-enabled
                            empty-label="[[emptyLabel]]"
                            empty-label-when-filtered="[[emptyLabelWhenFiltered]]"
                            selection-enabled
                            display-quick-filters
                            on-row-clicked="_navigate">

            <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.title')]]"
                                     field="dc:title" sort-by="dc:title" filter-by="title"  flex="100">
              <template>

                <nuxeo-document-thumbnail document="[[item]]"></nuxeo-document-thumbnail>
                <a class="title ellipsis" href$="#!/browse[[item.path]]" on-tap="_navigate">[[item.title]]</a>
              </template>
            </nuxeo-data-table-column>
            <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.modified')]]"
                                     field="dc:modified" sort-by="dc:modified"
                                     filter-by="dc_modified_agg"
                                     flex="50">
              <template is="header">
                <nuxeo-dropdown-aggregation
                                            placeholder="[[i18n('documentContentView.datatable.header.modified')]]"
                                            data="[[aggregations.dc_modified_agg]]"
                                            value="{{column.filterValue}}" multiple>
                </nuxeo-dropdown-aggregation>
              </template>
              <template>
                <nuxeo-date datetime="[[item.properties.dc:modified]]"></nuxeo-date>
              </template>
            </nuxeo-data-table-column>
            <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.lastContributor')]]"
                                     filter-by="dc_last_contributor_agg" field="dc:lastContributor" sort-by="dc:lastContributor" flex="50">
              <template is="header">
                <nuxeo-dropdown-aggregation
                                            placeholder="[[i18n('documentContentView.datatable.header.lastContributor')]]"
                                            data="[[aggregations.dc_last_contributor_agg]]"
                                            value="{{column.filterValue}}" multiple>
                </nuxeo-dropdown-aggregation>
              </template>
              <template>
                <nuxeo-user-tag user="[[item.properties.dc:lastContributor]]"></nuxeo-user-tag>
              </template>
            </nuxeo-data-table-column>

            <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.state')]]"
                                     field="currentLifeCycleState" hidden>
              <template><span class="capitalize">[[item.state]]</span></template>
            </nuxeo-data-table-column>

            <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.created')]]"
                                     field="dc:created" sort-by="dc:created" flex="50" hidden>
              <template>
                <nuxeo-date datetime="[[item.properties.dc:created]]"></nuxeo-date>
              </template>
            </nuxeo-data-table-column>

            <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.author')]]"
                                     field="dc:creator" sort-by="dc:creator" hidden>
              <template>
                <nuxeo-user-tag user="[[item.properties.dc:creator]]"></nuxeo-user-tag>
              </template>
            </nuxeo-data-table-column>

            <!--Drag and drop here all the additional metadata columns from the right -->
            <!-- add hidden attribute if you want them to be hidden by default-->

          </nuxeo-data-table>
        </nuxeo-results>



        <!--nuxeo-data-table role="widget" id="datatable" items="[[documents]]" on-row-clicked="_navigate">
          <nuxeo-data-table-column name="Full text search" flex="100" filter-by="ecm_fulltext" sort-by="dc:title">
            <template>
              <nuxeo-document-thumbnail document=[[item]]></nuxeo-document-thumbnail>
              [[item.title]]
            </template>
          </nuxeo-data-table-column>
          <nuxeo-data-table-column filter-by="dc_modified_agg" flex="50" sort-by="dc:modified">
            <template is="header">
              <nuxeo-dropdown-aggregation
                                          placeholder="Modified"
                                          data="[[documentAggregations.dc_modified_agg]]"
                                          value="{{column.filterValue}}" multiple>
              </nuxeo-dropdown-aggregation>
            </template>
            <template>
              [[_formatDate(item.properties.dc:modified)]]
            </template>
          </nuxeo-data-table-column>
          <nuxeo-data-table-column filter-by="dc_creator_agg" flex="50">
            <template is="header">
              <nuxeo-dropdown-aggregation
                                          placeholder="Author"
                                          data="[[documentAggregations.dc_creator_agg]]"
                                          value="{{column.filterValue}}" multiple>
              </nuxeo-dropdown-aggregation>
            </template>
            <template>
              <nuxeo-user-tag user="[[item.properties.dc:creator]]"></nuxeo-user-tag>
            </template>
          </nuxeo-data-table-column>
        </nuxeo-data-table-->
      </div>

        </paper-card>
      </template>

    <script>
    (function() {
      'use strict';
      Polymer({
        is: 'nuxeo-opportunity-view-layout',
        behaviors: [Nuxeo.LayoutBehavior],
        properties: {

          /**
           * @doctype Opportunity
           */
          document: {
            type: Object
          },

          params: {
            type: Object,
            value: {},
            notify: true
          }

        },
        ready:function(){
          this.nxProvider = this.$.nxProvider;
        },
        /**
       * Returns the label for the given directory entry.
       */
        formatDirectory: function(value) {
          if (value && value['entity-type'] && value['entity-type'] === 'directoryEntry') {
            if (value.properties && value.properties.label) {
              return value.properties.label;
            } else {
              var label = 'label_' + ((window.nuxeo.I18n.language) ? window.nuxeo.I18n.language.split('-')[0] : 'en');
              return value.properties[label] || value.properties['label_en']
            }
          } else {
            return value;
          }
        },
        _formatDate: function(date) {
          return moment(date).format('MMMM D, YYYY');
        },
        _formatCurrency: function(val) {
          if(val == null){
            return "";
          }
          return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        },
        _navigate: function(e) {
          var detail = {
            doc: e.detail.item,
          };
          page('/browse' + detail.doc.path);
        },
        _thumbnail: function(doc) {
          if (doc && doc.uid) {
            if (doc.contextParameters && doc.contextParameters.thumbnail.url) {
              return doc.contextParameters.thumbnail.url;
            } else {
              var baseUrl = this.$.nxcon.url;
              return baseUrl + '/api/v1/id/' + doc.uid + '/@rendition/thumbnail';
            }
          }
        },
        _href: function(item) {
          return this.urlFor('user', item.id);
        },
      });
    })();
    </script>
    </dom-module>
