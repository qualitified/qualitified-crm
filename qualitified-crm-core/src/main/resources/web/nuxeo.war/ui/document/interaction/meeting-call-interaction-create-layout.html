<link rel="import" href="../../elements/qualitified-time-picker.html">
<link rel="import" href="../qualitified-custom-fields.html">

<dom-module id="meeting-call-interaction-create-layout">
    <template>
        <style include="nuxeo-styles">
      *[role=widget] {
        padding: 5px;
      }

      .dateFields {
        align-items: start;
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
      }
    </style>

        <paper-toast id="operationToast"></paper-toast>
        <nuxeo-resource id="tokens" path="oauth2/token/"></nuxeo-resource>
        <nuxeo-resource id="oauth" path="oauth2/provider/"></nuxeo-resource>
        <nuxeo-connection id="nxuser" user="{{currentUser}}">
        </nuxeo-connection>
        <nuxeo-operation id="getContactDoc" op="Repository.GetDocument"></nuxeo-operation>

        <nuxeo-input role="widget"
                     value="{{document.properties.dc:title}}"
                     label="[[i18n('label.metadata.interaction.title')]]"
                     required>
        </nuxeo-input>

        <nuxeo-textarea role="widget"
                        value="{{document.properties.dc:description}}"
                        label="[[i18n('label.metadata.interaction.description')]]">
        </nuxeo-textarea>

        <nuxeo-directory-suggestion role="widget"
                                    value="{{document.properties.interaction:status}}"
                                    label="[[i18n('label.metadata.status')]]"
                                    required="true"
                                    directory-name="IntStatus"
                                    min-chars="0">
        </nuxeo-directory-suggestion>

        <qualitified-user-suggestion role="widget"
                               id="IntResponsible"
                               value="{{document.properties.interaction:responsible}}"
                               on-value-changed="_isCurrentUser"
                               label="[[i18n('label.metadata.responsible')]]"
                               search-type="USER_TYPE"
                               min-chars="0"
                               multiple="true">
        </qualitified-user-suggestion>

        <qualitified-document-suggestion id="IntContact"
                                         role="widget"
                                         value="{{document.properties.interaction:contact}}"
                                         multiple="true"
                                         label="[[i18n('label.metadata.contact')]]"
                                         page-provider="documents"
                                         min-chars="0"
                                         params='{ "namedParameters": "system_primaryType=Contact"}'>
        </qualitified-document-suggestion>

        <div class="dateFields">
            <qualitified-time-picker value="{{document.properties.interaction:date}}"
                                     display-duration="{{document.properties.interaction:toSync}}"
                                     duration="{{document.properties.interaction:eventDuration}}"
                                     date-label="Date"
                                     duration-label="Duration"
                                     role="widget">
            </qualitified-time-picker>
            <div hidden$="[[isHidden]]">
                <h style="color:red;">Date is required to enable synchronization!</h><br />
            </div>
        </div>

        <template is="dom-if" if="[[canSync]]">
            <paper-toggle-button id="synchBtn" on-tap="_checkDateFields" on-change="_handleAuth" checked="{{document.properties.interaction:toSync}}">
                Synchronize with google calendar
            </paper-toggle-button>
        </template>

        <qualitified-custom-fields document="{{document}}" mode="edit"></qualitified-custom-fields>
    </template>


    <!--dialog for google calendar synchronization -->
    <nuxeo-dialog id="dialog" with-backdrop="" on-iron-overlay-closed="" no-auto-focus="">
        <h2>Synchronize with google calendar</h2>
        <div class="content">
            <h style="color:red;">To enable synchronization! please connect to your google account and try again.</h><br />
        </div>
        <div class="buttons">
            <paper-button dialog-dismiss="" noink="">Cancel</paper-button>
            <paper-button class="primary" name="add" on-click="_toggleWindow">
                Connect to google
            </paper-button>
        </div>
    </nuxeo-dialog>

    </template>

    <script>
    (function () {
      'use strict';
      Polymer({
        is: 'meeting-call-interaction-create-layout',
        behaviors: [Nuxeo.LayoutBehavior],
        properties: {

          /**
             * @doctype Interaction
             */
          document: {
            type: Object
          },
          displayDuration: {
            type: Boolean,
            value: false
          },
          currentUser: {
            type: Object,
            observer: '_canSync'
          },
          canSync: {
            type: Boolean,
            value: false
          },
          authURL: {
            type: String
          },
          isHidden: {
            type: Boolean,
            value: true
          }

        },

        _canSync: function () {
          if (this.document) {
            var responsible = this.document.properties['interaction:responsible'];
            if (responsible.length === 1  &&  responsible[0] === this.currentUser.id) {
              this.canSync = true;
            } else this.canSync = false;
          }
        },

        _isCurrentUser: function (e) {
          if (this.document) {
            var responsible = this.$.IntResponsible.value;
            if (responsible.length === 1  &&  responsible[0] === this.currentUser.id) {
              this.canSync = true;
            } else this.canSync = false;
          }
        },

        _checkDateFields: function () {
          if (this.document) {
            var startDte = this.document.properties['interaction:date'];
            if (this.document.properties['interaction:toSync']=== true) {
              if (startDte && startDte !== "Invalid date") {
                this.isHidden = true;
                return true;
              } else {
                this.isHidden = false;
                this.set('document.properties.interaction:toSync', false);

                //this.$.synchBtn.checked = false;
                return false;
              }
            }
          }
        },

        _handleAuth: function (e) {
          if (this._checkDateFields()) {
            this.set('document.properties.interaction:eventDuration', "15");
            this.$.oauth.get().then(function (response) {
              if (response.entries && response.entries.length > 0)
              response.entries.forEach(serviceProvider => {
                if (serviceProvider.serviceName === "googleCalendar") {
                  this.authURL = serviceProvider.authorizationURL;
                  if (serviceProvider.isAuthorized === true) {
                    this.$.operationToast.text = "Synch is on!";
                    this.$.operationToast.open();
                    //this.document.properties['custom:booleanField1'] = this.isSynchBtnChecked;
                  } else {
                    this.$.synchBtn.checked = false;
                    this.$.dialog.toggle();
                  }
                }
              });
            }.bind(this));
          }
        },
        _toggleWindow: function () {
          //var redirect_uri = document.location.origin+"/nuxeo/site/oauth2/docusign/callback";
          var googleAuthWindow = window.open(this.authURL, "google oauth2", "resizable,scrollbars,status,width=800,height=800");
          this.$.dialog.toggle();
        }

      });
    })();
  </script>
</dom-module>