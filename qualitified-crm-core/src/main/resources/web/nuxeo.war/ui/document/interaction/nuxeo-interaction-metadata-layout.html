<link rel="import" href="../qualitified-custom-fields.html">
<link rel="import" href="../../elements/qualitified-time-picker.html">
<link rel="import" href="../../shared-css.html">

<dom-module id="nuxeo-interaction-metadata-layout">
    <template>
        <style include="shared-css">
            *[role=widget] {
                padding: 5px;
            }

            .wrap {
                white-space: pre-wrap;
            }

            .account-view-layout {
                height: 25px;
                width: 25px;
                border-radius: 20px;
                box-sizing: border-box;
                margin-right: 8px;
            }
            .statusIcon {
                margin-bottom: 4px;
            }

            paper-toggle-button {
                pointer-events: none;
            }
        </style>
        <div role="widget" class="title">
            <h1 directory-name="IntActivity">
                [[formatDirectory(document.properties.interaction:activity)]] - [[document.properties.dc:title]] -
            <iron-icon class="statusIcon" icon="[[_getStatusIcon(document.properties.interaction:status)]]"></iron-icon>
            </h1> 
        </div>
        <div role="widget">
            <qualitified-inline-edit document="[[document]]"
                                     property="interaction:activity"
                                     label="[[i18n('label.metadata.activity')]]"
                                     metadata="directory"
                                     directory="IntActivity"
                                     value="[[formatDirectory(document.properties.interaction:activity)]]">
            </qualitified-inline-edit>
        </div>
        <div role="widget">
            <qualitified-inline-edit document="[[document]]"
                                     property="interaction:status"
                                     label="[[i18n('label.metadata.status')]]"
                                     metadata="directory"
                                     directory="IntStatus"
                                     value="[[formatDirectory(document.properties.interaction:status)]]">
            </qualitified-inline-edit>
        </div>
        <div role="widget">
            <qualitified-inline-edit document="[[document]]"
                                     property="interaction:date"
                                     label="label.metadata.date"
                                     metadata="date">
            </qualitified-inline-edit>
        </div>

        <template if="[[!document.properties.note:note]]" is="dom-if">
            <div role="widget">
                <qualitified-inline-edit document="[[document]]"
                                         property="dc:description"
                                         value="[[document.properties.dc:description]]"
                                         label="[[i18n('label.metadata.interaction.description')]]">
                </qualitified-inline-edit>
            </div>
        </template>
        <template if="[[document.properties.note:note]]" is="dom-if">
            <div role="widget">
                <qualitified-inline-edit document="[[document]]"
                                         property="note:note"
                                         value="[[document.properties.note:note]]"
                                         label="[[i18n('label.metadata.interaction.description')]]">
                </qualitified-inline-edit>
            </div>
        </template>

        <div role="widget" hidden$="[[_isHidden(document.properties.interaction:responsible)]]">
            <qualitified-inline-edit document="[[document]]"
                                     value="[[document.properties.interaction:responsible]]"
                                     property="interaction:responsible"
                                     label="label.metadata.responsible"
                                     multiple
                                     metadata="user">
            </qualitified-inline-edit>
        </div>
        <div role="widget" hidden$="[[_isHidden(document.properties.interaction:contact)]]">
            <qualitified-inline-edit document="[[document]]"
                                     value="[[document.properties.interaction:contact]]"
                                     property="interaction:contact"
                                     parent-to-select="Account"
                                     addable
                                     multiple
                                     clickable
                                     label="[[i18n('label.metadata.contact')]]"
                                     params='{ "namedParameters": "system_primaryType=Contact"}'
                                     metadata="document">
            </qualitified-inline-edit>
        </div>
        <template is="dom-if" if="[[document.properties.custom:booleanField1]]">
            <paper-toggle-button id="synchBtn" checked="{{document.properties.custom:booleanField1}}">
                Synced with google calendar
            </paper-toggle-button>
        </template>
        <qualitified-custom-fields document="{{document}}" mode="view"></qualitified-custom-fields>
        <nuxeo-document-attachments role="widget" document="[[document]]"></nuxeo-document-attachments>
    </template>

    <script>
        (function () {
            'use strict';
            Polymer({
                is: 'nuxeo-interaction-metadata-layout',
                behaviors: [Nuxeo.LayoutBehavior],
                properties: {

                    document: {
                        type: Object,
                        observer: '_documentReady'
                    }
                },
                /**
                 * Returns the label for the given directory entry.
                 */
                formatDirectory: function (value) {
                    if (value && value['entity-type'] && value['entity-type'] === 'directoryEntry') {
                        if (value.properties && value.properties.label) {
                            return value.properties.label;
                        } else {
                            var label = 'label_' + ((window.nuxeo.I18n.language) ? window.nuxeo.I18n.language.split('-')[0] : 'en');
                            return value.properties[label] || value.properties['label_en']
                        }
                    } else {
                        return value;
                    }
                },

                _getStatusIcon: function(status){
                  if (status.id === 'DONE') {
                   return 'icons:assignment-turned-in';
                  } else return 'icons:event';
                },

                formatDate: function (date) {
                    return moment(date).format('MMMM D, YYYY');
                },
                _isHidden: function (valueList) {
                    var hidden = true;
                    if (valueList.length > 0) {
                        hidden = false;
                    }
                    return hidden;
                },
                _hasNote: function (doc) {
                    return doc && doc.properties['note:note'] !== null;
                },
                _hasProfileImg: function (value) {
                    var img = document.createElement('img');
                    img.src = "/nuxeo/nxfile/default/" + value + "/file:content/";
                    return "/nuxeo/nxfile/default/" + value + "/file:content/";
                },
                _navigate: function (oEvent) {
                    this.navigateTo('document', oEvent.model.get('contact'));
                },
                _documentReady: function (doc) {
                    if (doc) {
                        document.querySelector("nuxeo-app").shadowRoot.querySelector("qualitified-group-menu")._getCount();
                    }
                }
            });
        })();


    </script>
</dom-module>