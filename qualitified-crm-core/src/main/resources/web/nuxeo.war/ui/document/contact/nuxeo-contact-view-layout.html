<link rel="import" href="../../shared-css.html">
<link rel="import" href="../../elements/qualitified-document-attachments.html">
<link rel="import" href="../../qualitified-icons.html">
<link rel="import" href="../../elements/nuxeo-document-create-popup-modified.html">
<link rel="import" href="../../elements/qualitified-create-interaction-contact.html">
<dom-module id="nuxeo-contact-view-layout">
  <template>
    <style include="nuxeo-styles shared-css">


      *[role=widget] {
        padding: 40px;
        flex: 80%;
      }

      nuxeo-data-table {
        height: 100%;
      }

      .dataTable{
        /*height: 300px;*/
      }

      .queue-thumbnail {
        height: 32px;
        width: 32px;
        border-radius: 20px;
        box-sizing: border-box;
        margin-right: 8px;
      }

      .queue-thumbnail ::content img {
        height: 32px;
        width: 32px;
        border-radius: 20px;
        box-sizing: border-box;
        margin-right: 8px;
      }
      .results {
        @apply(--layout-vertical);
        @apply(--layout-flex);
        /* min-height: calc(60vh - 14em); */
        /*margin-top: 8px;*/
      }



      .results.dragging {
        border: 2px dashed var(--nuxeo-primary-color);
      }


      .capitalize {
        text-transform: capitalize;
      }
      .activity-bar{
        margin-bottom: 10px;
      }

      .border-bottom {
        border-top: 1px solid var(--nuxeo-border);
        padding: 8px 0;
      }

    </style>
    <nuxeo-connection id="nxcon"></nuxeo-connection>
    <nuxeo-page-provider role="widget"
                         id="interactionTodoProvider"
                         auto
                         query="SELECT * FROM Interaction WHERE ecm:currentLifeCycleState != 'deleted' and ecm:isTrashed = 0 and  interaction:contact IN ('[[document.uid]]') AND ecm:currentLifeCycleState = 'todo' ORDER BY interaction:date DESC"
                         page-size="1"
                         params="[[params]]"
                         aggregations="{{interactionTodoAggregations}}"
                         current-page="{{interactionsTodo}}">
    </nuxeo-page-provider>
    <template is="dom-repeat" items="[[interactionsTodo]]">
      <nuxeo-card role="widget" icon="qualitified:idea" heading="[[i18n('label.next.best.action')]]">
        <div>
          <a href$="#!/browse[[item.path]]">
            <template is="dom-if" if="[[_isCall(item.properties.interaction:activity)]]">
              <iron-icon icon="icons:settings-phone"></iron-icon>
            </template>
            <template is="dom-if" if="[[_isMeeting(item.properties.interaction:activity)]]">
              <iron-icon icon="icons:perm-contact-calendar"></iron-icon>
            </template>
            <template is="dom-if" if="[[_isChat(item.properties.interaction:activity)]]">
              <iron-icon icon="icons:supervisor-account"></iron-icon>
            </template>
            <template is="dom-if" if="[[_isEmail(item.properties.interaction:activity)]]">
              <iron-icon icon="icons:mail"></iron-icon>
            </template>
            <template is="dom-if" if="[[_isNote(item.properties.interaction:activity)]]">
              <iron-icon icon="icons:speaker-notes"></iron-icon>
            </template>
            <template is="dom-if" if="[[_isSms(item.properties.interaction:activity)]]">
              <iron-icon icon="icons:perm-phone-msg"></iron-icon>
            </template>
            - [[item.title]]
          </a>
          <div style="margin-bottom:-14px; margin-top:10px;">
            <qualitified-inline-edit document="[[item]]"
                                     value="[[item.properties.interaction:contact]]"
                                     property="interaction:contact"
                                     parent-to-select="Account"
                                     multiple
                                     clickable
                                     label="[[i18n('label.metadata.contact')]]"
                                     params='{ "namedParameters": "system_primaryType=Contact"}'
                                     metadata="document">
            </qualitified-inline-edit>
          </div>
          <qualitified-inline-edit document="[[item]]"
                                   property="interaction:activity"
                                   label="label.metadata.activity"
                                   directory="IntActivity"
                                   metadata="directory">
          </qualitified-inline-edit>

          <template if="[[!item.properties.note:note]]" is="dom-if">
            <qualitified-inline-edit document="[[item]]"
                                     property="dc:description"
                                     label="label.metadata.interaction.description"
                                     metadata="textarea">
            </qualitified-inline-edit>
          </template>
          <template if="[[item.properties.note:note]]" is="dom-if">
            <qualitified-inline-edit document="[[item]]"
                                     property="note:note"
                                     label="label.metadata.interaction.description"
                                     metadata="textarea">
            </qualitified-inline-edit>
          </template>

          <qualitified-inline-edit document="[[item]]"
                                   property="interaction:date"
                                   parent-providers="[[providers]]"
                                   label="label.metadata.date"
                                   metadata="date">
          </qualitified-inline-edit>
          <qualitified-inline-edit document="[[item]]"
                                   property="interaction:status"
                                   label="label.metadata.status"
                                   parent-providers="[[providers]]"
                                   directory="IntStatus"
                                   metadata="directory">
          </qualitified-inline-edit>

        </div>
      </nuxeo-card>
    </template>

    <paper-card role="widget">
      <h3>
        [[i18n('label.activities')]]
      </h3>
      <qualitified-create-interaction-contact id="createPopup" type="Interaction">
      </qualitified-create-interaction-contact>
      <div class="activity-bar">
        <paper-button style="border-radius: 25px;" noink="" id="new"
                      className="primary horizontal layout center" on-tap="_openDialogCall" elevation="0">
          <iron-icon icon="qualitified:call"></iron-icon>
          [[i18n('label.call')]]
        </paper-button>
        <paper-button style="border-radius: 25px;" noink="" id="new"
                      className="primary horizontal layout center" on-tap="_openDialogChat" elevation="0">
          <iron-icon icon="qualitified:chat"></iron-icon>
          [[i18n('label.chat')]]
        </paper-button>
        <paper-button style="border-radius: 25px;" noink="" id="new"
                      className="primary horizontal layout center" on-tap="_openDialogEmailing" elevation="0">
          <iron-icon icon="qualitified:emailing"></iron-icon>
          [[i18n('label.emailing')]]
        </paper-button>
        <paper-button style="border-radius: 25px;" noink="" id="new"
                      className="primary horizontal layout center" on-tap="_openDialogMeeting" elevation="0">
          <iron-icon icon="qualitified:meeting"></iron-icon>
          [[i18n('label.meeting')]]
        </paper-button>
        <paper-button style="border-radius: 25px;" noink="" id="new"
                      className="primary horizontal layout center" on-tap="_openDialogNote" elevation="0">
          <iron-icon icon="qualitified:note"></iron-icon>
          [[i18n('label.note')]]
        </paper-button>
        <paper-button style="border-radius: 25px;" noink="" id="new"
                      className="primary horizontal layout center" on-tap="_openDialogSMS" elevation="0">
          <iron-icon icon="qualitified:sms"></iron-icon>
          [[i18n('label.sms')]]
        </paper-button>
      </div>

      <!-- /Create a new Link -->

      <div className="dataTable">
        <nuxeo-page-provider role="widget"
                             id="interactionProvider"
                             auto
                             query="SELECT * FROM Interaction WHERE ecm:currentLifeCycleState != 'deleted' and ecm:isTrashed = 0 and  interaction:contact IN ('[[document.uid]]') AND ecm:currentLifeCycleState = 'done' ORDER BY interaction:date DESC"
                             page-size="40"
                             params="[[params]]"
                             aggregations="{{interactionAggregations}}"
                             current-page="{{interactions}}">
        </nuxeo-page-provider>

        <template is="dom-repeat" items="[[interactions]]">
          <div class="border-bottom">

            <!-- <div>[[_formatDate(item.properties.interaction:date)]]</div>
            </br> -->
            <div>
              <a href$="#!/browse[[item.path]]">
                <template is="dom-if" if="[[_isCall(item.properties.interaction:activity)]]">
                  <iron-icon icon="icons:settings-phone"></iron-icon>
                </template>
                <template is="dom-if" if="[[_isMeeting(item.properties.interaction:activity)]]">
                  <iron-icon icon="icons:perm-contact-calendar"></iron-icon>
                </template>
                <template is="dom-if" if="[[_isChat(item.properties.interaction:activity)]]">
                  <iron-icon icon="icons:supervisor-account"></iron-icon>
                </template>
                <template is="dom-if" if="[[_isEmail(item.properties.interaction:activity)]]">
                  <iron-icon icon="icons:mail"></iron-icon>
                </template>
                <template is="dom-if" if="[[_isNote(item.properties.interaction:activity)]]">
                  <iron-icon icon="icons:speaker-notes"></iron-icon>
                </template>
                <template is="dom-if" if="[[_isSms(item.properties.interaction:activity)]]">
                  <iron-icon icon="icons:perm-phone-msg"></iron-icon>
                </template>
                - [[_formatDate(item.properties.interaction:date)]] - [[item.title]]
              </a>
              <template is="dom-if" if="[[_isSendingEmail(item.properties.interaction:activity,item.properties.custom:booleanField2)]]">
                <template is="dom-if" if="[[_isSent(item.properties.interaction:isSent)]]">
                  <iron-icon id="notSent-[[item.uid]]" style="float: right;color: #2bd670;" icon="icons:check-circle"></iron-icon>
                  <paper-tooltip for="notSent-[[item.uid]]">Mail is sent</paper-tooltip>
                </template>
                <template is="dom-if" if="[[!_isSent(item.properties.interaction:isSent)]]">
                  <iron-icon id="notSent-[[item.uid]]" style="float: right;color: #e83e34;" icon="icons:info-outline"></iron-icon>
                  <paper-tooltip for="notSent-[[item.uid]]">Mail is not sent</paper-tooltip>
                </template>
              </template>
            </div>
            </br>
            <qualitified-document-suggestion value="[[item.properties.interaction:contact]]"
                                             display-style="viewInlineStyle"
                                             multiple
                                             clickable
                                             readOnly>
            </qualitified-document-suggestion>
            <div hidden$=[[_hasNote(item)]]>
              <pre class="wrap">[[item.properties.dc:description]]</pre>
            </div>
            <iron-collapse hidden$=[[!_hasNote(item)]] id="collapse-[[item.uid]]">
              <div>
                <pre class="wrap">[[item.properties.note:note]]</pre>
              </div>
            </iron-collapse>

            <button hidden$=[[!_hasNote(item)]] id="button-[[item.uid]]" on-click="toggle" data-id$="[[item.uid]]">
              ...
            </button>
            <qualitified-document-attachments document="[[item]]"></qualitified-document-attachments>
            <br />
          </div>
        </template>
      </div>
    </paper-card>
    <paper-card role="widget">

      <paper-tabs selected="{{selected}}" scrollable>
        <paper-tab>[[i18n('Opportunities')]]</paper-tab>
        <paper-tab>[[i18n('Solicitations')]]</paper-tab>
        <paper-tab>[[i18n('Attachments')]]</paper-tab>
      </paper-tabs>

      <iron-pages selected="{{selected}}">

        <div class="dataTable">
          <nuxeo-page-provider id="opportunityProvider"
                               query="select * from Opportunity where ecm:currentLifeCycleState != 'deleted' and ecm:isTrashed = 0 and opportunity:mainContact = '[[document.uid]]' "
                               page-size="40"
                               aggregations="{{opportunityAggregations}}"
                               enrichers="thumbnail, permissions"
                               page="[[pageNumber]]"
                               params="[[params]]"
                               schemas="opportunity,dublincore,common,uid,file"
                               headers='{"X-NXfetch.document": "properties", "X-NXtranslate.directoryEntry": "label"}'
                               fetch-aggregates>
          </nuxeo-page-provider>

          <nuxeo-results name="[[document.uid]]" nx-provider="[[opportunityProvider]]" selected-items="{{selectedItems}}">
            <!-- <div class="selectionActions">
              <nuxeo-slot slot="BROWSE_ACTIONS" model="[[browseActionContext]]"></nuxeo-slot>
            </div> -->


            <!-- Table view -->
            <nuxeo-data-table class="results" name="table" icon="nuxeo:view-list"
                              settings-enabled
                              empty-label="[[emptyLabel]]"
                              empty-label-when-filtered="[[emptyLabelWhenFiltered]]"
                              selection-enabled
                              display-quick-filters
                              on-row-clicked="_navigate">

              <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.title')]]"
                                       field="dc:title" sort-by="dc:title" filter-by="title"  flex="100">
                <template>

                  <nuxeo-document-thumbnail document="[[item]]"></nuxeo-document-thumbnail>
                  <a class="title ellipsis" href$="#!/browse[[item.path]]" on-tap="_navigate">[[item.title]]</a>
                </template>
              </nuxeo-data-table-column>

              <nuxeo-data-table-column name="Amount" field="opportunity:amount" sort-by="opportunity:amount"
                                       flex="50">
                <template>
                  [[_formatCurrency(item.properties.opportunity:amount)]] â‚¬
                </template>
              </nuxeo-data-table-column>

              <nuxeo-data-table-column name="Close Date" field="opportunity:closeDate" sort-by="opportunity:closeDate"
                                       flex="50">
                <template>
                  [[formatDate(item.properties.opportunity:closeDate)]]
                </template>
              </nuxeo-data-table-column>

              <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.state')]]"
                                       field="currentLifeCycleState">
                <template>
                  <span class$="[[item.state]] state">[[item.state]]</span>
                </template>
              </nuxeo-data-table-column>

              <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.modified')]]"
                                       field="dc:modified" sort-by="dc:modified"
                                       filter-by="dc_modified_agg"
                                       flex="50">
                <template is="header">
                  <nuxeo-dropdown-aggregation
                          placeholder="[[i18n('documentContentView.datatable.header.modified')]]"
                          data="[[opportunityAggregations.dc_modified_agg]]"
                          value="{{column.filterValue}}" multiple>
                  </nuxeo-dropdown-aggregation>
                </template>
                <template>
                  <nuxeo-date datetime="[[item.properties.dc:modified]]"></nuxeo-date>
                </template>
              </nuxeo-data-table-column>

              <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.lastContributor')]]"
                                       filter-by="dc_last_contributor_agg" field="dc:lastContributor" sort-by="dc:lastContributor" flex="50" hidden>
                <template is="header">
                  <nuxeo-dropdown-aggregation
                          placeholder="[[i18n('documentContentView.datatable.header.lastContributor')]]"
                          data="[[opportunityAggregations.dc_last_contributor_agg]]"
                          value="{{column.filterValue}}" multiple>
                  </nuxeo-dropdown-aggregation>
                </template>
                <template>
                  <nuxeo-user-tag user="[[item.properties.dc:lastContributor]]"></nuxeo-user-tag>
                </template>
              </nuxeo-data-table-column>

            </nuxeo-data-table>
          </nuxeo-results>
        </div>


        <div class="dataTable">
          <nuxeo-page-provider id="sollicitationProvider"
                               query="select * from Solicitation where ecm:currentLifeCycleState != 'deleted' and ecm:isTrashed = 0 and ecm:parentId = '[[document.uid]]'"
                               page-size="40"
                               aggregations="{{sollicitationAggregations}}"
                               enrichers="thumbnail, permissions"
                               page="[[pageNumber]]"
                               params="[[params]]"
                               schemas="solicitation,dublincore,common,uid,file"
                               headers='{"X-NXfetch.document": "properties", "X-NXtranslate.directoryEntry": "label"}'
                               fetch-aggregates>
          </nuxeo-page-provider>

          <nuxeo-results name="[[document.uid]]" nx-provider="[[sollicitationProvider]]" selected-items="{{selectedItems}}">
            <!-- <div class="selectionActions">
              <nuxeo-slot slot="BROWSE_ACTIONS" model="[[browseActionContext]]"></nuxeo-slot>
            </div> -->


            <!-- Table view -->
            <nuxeo-data-table class="results" name="table" icon="nuxeo:view-list"
                              settings-enabled
                              empty-label="[[emptyLabel]]"
                              empty-label-when-filtered="[[emptyLabelWhenFiltered]]"
                              selection-enabled
                              display-quick-filters
                              on-row-clicked="_navigate">

              <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.title')]]"
                                       field="dc:title" sort-by="dc:title" filter-by="title"  flex="100">
                <template>
                  <img class="queue-thumbnail" src="[[_thumbnail(item)]]">
                  <a class="title ellipsis" href$="#!/browse[[item.path]]" on-tap="_navigate">[[item.title]]</a>
                </template>
              </nuxeo-data-table-column>

              <nuxeo-data-table-column name="Status" field="solicitation:status" sort-by="solicitation:status"
                                       flex="50">
                <template>
                  [[formatDirectory(item.properties.solicitation:status)]]
                </template>
              </nuxeo-data-table-column>

              <nuxeo-data-table-column name="Date" field="dc:modified" sort-by="dc:modified"
                                       flex="50">
                <template>
                  [[formatDate(item.properties.dc:modified)]]
                </template>
              </nuxeo-data-table-column>

              <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.modified')]]"
                                       field="dc:modified" sort-by="dc:modified"
                                       filter-by="dc_modified_agg"
                                       flex="50">
                <template is="header">
                  <nuxeo-dropdown-aggregation
                          placeholder="[[i18n('documentContentView.datatable.header.modified')]]"
                          data="[[sollicitationAggregations.dc_modified_agg]]"
                          value="{{column.filterValue}}" multiple>
                  </nuxeo-dropdown-aggregation>
                </template>
                <template>
                  <nuxeo-date datetime="[[item.properties.dc:modified]]"></nuxeo-date>
                </template>
              </nuxeo-data-table-column>

              <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.lastContributor')]]"
                                       filter-by="dc_last_contributor_agg" field="dc:lastContributor" sort-by="dc:lastContributor" flex="50" hidden>
                <template is="header">
                  <nuxeo-dropdown-aggregation
                          placeholder="[[i18n('documentContentView.datatable.header.lastContributor')]]"
                          data="[[sollicitationAggregations.dc_last_contributor_agg]]"
                          value="{{column.filterValue}}" multiple>
                  </nuxeo-dropdown-aggregation>
                </template>
                <template>
                  <nuxeo-user-tag user="[[item.properties.dc:lastContributor]]"></nuxeo-user-tag>
                </template>
              </nuxeo-data-table-column>

              <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.created')]]"
                                       field="dc:created" sort-by="dc:created" flex="50" hidden>
                <template>
                  <nuxeo-date datetime="[[item.properties.dc:created]]"></nuxeo-date>
                </template>
              </nuxeo-data-table-column>
            </nuxeo-data-table>
          </nuxeo-results>
        </div>

        <div class="dataTable">
          <nuxeo-page-provider id="documentProvider"
                               query="select * from Document where ecm:primaryType in ('File', 'Folder', 'Picture', 'Video', 'Audio') and ecm:currentLifeCycleState != 'deleted' and ecm:isTrashed = 0 and ecm:parentId = '[[document.uid]]' "
                               page-size="40"
                               aggregations="{{documentAggregations}}"
                               enrichers="thumbnail, permissions"
                               page="[[pageNumber]]"
                               params="[[params]]"
                               schemas="dublincore,common,uid,file"
                               headers='{"X-NXfetch.document": "properties", "X-NXtranslate.directoryEntry": "label"}'
                               fetch-aggregates>
          </nuxeo-page-provider>

          <nuxeo-results name="[[document.uid]]" nx-provider="[[documentProvider]]" selected-items="{{selectedItems}}">
            <!-- <div class="selectionActions">
              <nuxeo-slot slot="BROWSE_ACTIONS" model="[[browseActionContext]]"></nuxeo-slot>
            </div> -->


            <!-- Table view -->
            <nuxeo-data-table class="results"
                              name="table"
                              icon="nuxeo:view-list"
                              settings-enabled
                              empty-label="[[emptyLabel]]"
                              empty-label-when-filtered="[[emptyLabelWhenFiltered]]"
                              selection-enabled
                              draggable$="[[_hasWritePermission(document)]]"
                              drop-target-filter="[[_dropTargetFilter]]"
                              display-quick-filters
                              on-row-clicked="_navigate">

              <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.title')]]"
                                       field="dc:title" sort-by="dc:title" filter-by="title"  flex="100">
                <template>
                  <img class="queue-thumbnail" src="[[_thumbnail(item)]]">
                  <a class="title ellipsis" href$="#!/browse[[item.path]]" on-tap="_navigate">[[item.title]]</a>
                </template>
              </nuxeo-data-table-column>
              <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.modified')]]"
                                       field="dc:modified" sort-by="dc:modified"
                                       filter-by="dc_modified_agg"
                                       flex="50">
                <template is="header">
                  <nuxeo-dropdown-aggregation
                          placeholder="[[i18n('documentContentView.datatable.header.modified')]]"
                          data="[[documentAggregations.dc_modified_agg]]"
                          value="{{column.filterValue}}" multiple>
                  </nuxeo-dropdown-aggregation>
                </template>
                <template>
                  <nuxeo-date datetime="[[item.properties.dc:modified]]"></nuxeo-date>
                </template>
              </nuxeo-data-table-column>
              <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.lastContributor')]]"
                                       filter-by="dc_last_contributor_agg" field="dc:lastContributor" sort-by="dc:lastContributor" flex="50" hidden>
                <template is="header">
                  <nuxeo-dropdown-aggregation
                          placeholder="[[i18n('documentContentView.datatable.header.lastContributor')]]"
                          data="[[documentAggregations.dc_last_contributor_agg]]"
                          value="{{column.filterValue}}" multiple>
                  </nuxeo-dropdown-aggregation>
                </template>
                <template>
                  <nuxeo-user-tag user="[[item.properties.dc:lastContributor]]"></nuxeo-user-tag>
                </template>
              </nuxeo-data-table-column>

              <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.state')]]"
                                       field="currentLifeCycleState" hidden>
                <template><span class="capitalize">[[item.state]]</span></template>
              </nuxeo-data-table-column>

              <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.created')]]"
                                       field="dc:created" sort-by="dc:created" flex="50" hidden>
                <template>
                  <nuxeo-date datetime="[[item.properties.dc:created]]"></nuxeo-date>
                </template>
              </nuxeo-data-table-column>

              <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.author')]]"
                                       field="dc:creator" sort-by="dc:creator" hidden>
                <template>
                  <nuxeo-user-tag user="[[item.properties.dc:creator]]"></nuxeo-user-tag>
                </template>
              </nuxeo-data-table-column>

              <!--Drag and drop here all the additional metadata columns from the right -->
              <!-- add hidden attribute if you want them to be hidden by default-->

            </nuxeo-data-table>
          </nuxeo-results>
        </div>

      </iron-pages>
    </paper-card>
  </template>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'nuxeo-contact-view-layout',
        behaviors: [Nuxeo.LayoutBehavior, Nuxeo.DocumentContentBehavior],
        properties: {

          /**
           * @doctype Contact
           */
          document: {
            type: Object
          },
          params: {
            type: Object,
            value: {},
            notify: true
          }
        },
        observers: [
          '_refresh(params)',
          '_observeDocument(document)'
        ],
        ready: function() {
          this.selected = 0;
          if (this.document) {
            this.params = {'ecm_parentId': this.document.uid};
          }

          this.opportunityProvider = this.$.opportunityProvider;
          this.interactionProvider = this.$.interactionProvider;
          this.sollicitationProvider = this.$.sollicitationProvider;
          this.documentProvider = this.$.documentProvider;
        },
        _formatCurrency: function(val) {
          if(val == null){
            return "";
          }
          return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        },
        _thumbnail: function(doc) {
          if (doc && doc.uid) {
            if (doc.contextParameters && doc.contextParameters.thumbnail.url) {
              return doc.contextParameters.thumbnail.url;
            } else {
              var baseUrl = this.$.nxcon.url;
              return baseUrl + '/api/v1/id/' + doc.uid + '/@rendition/thumbnail';
            }
          }
        },
        /**
         * Returns the label for the given directory entry.
         */
        formatDirectory: function(value) {
          if (value && value['entity-type'] && value['entity-type'] === 'directoryEntry') {
            if (value.properties && value.properties.label) {
              return value.properties.label;
            } else {
              var label = 'label_' + ((window.nuxeo.I18n.language) ? window.nuxeo.I18n.language.split('-')[0] : 'en');
              return value.properties[label] || value.properties['label_en']
            }
          } else {
            return value;
          }
        },
        _isCall: function (value) {
          return value == 'Call';
        },

        _isMeeting: function (value) {
          return value == 'Meeting';
        },
        _isChat: function (value) {
          return value == 'Chat';
        },
        _isEmail: function (value) {
          return value == 'Email';
        },
        _isNote: function (value) {
          return value == 'Note';
        },
        _isSms: function (value) {
          return value == 'SMS';
        },
        _hasProfileImg: function(value){
          if(value != null){
            return true;
          }
          return false;
        },
        _getOppContact: function(){
          var oppContacts= [];
          oppContacts.push(this.document.uid);
          return oppContacts;
        },
        _isSendingEmail: function(activity,toSent) {
          return activity === 'Email' && toSent === true;
        },
        _isSent: function(isSent) {
          return isSent && isSent === 1;
        },
        _openDialogCall: function () {
          this.$.createPopup._createActivity('Call',this._getOppContact());
        },
        _openDialogChat: function () {
          this.$.createPopup._createActivity('Chat',this._getOppContact());

        },
        _openDialogEmailing: function () {
          this.$.createPopup._createActivity('Email',this._getOppContact());

        },
        _openDialogMeeting: function () {
          this.$.createPopup._createActivity('Meeting',this._getOppContact());

        },
        _openDialogNote: function () {
          this.$.createPopup._createActivity('Note',this._getOppContact());

        },
        _openDialogSMS: function () {
          this.$.createPopup._createActivity('SMS',this._getOppContact());

        }
      });
    })();
  </script>
</dom-module>
