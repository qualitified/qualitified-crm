<link href="../qualitified-custom-fields.html" rel="import">
<link rel="import" href="../../nuxeo-chart-data-behavior.html">
<dom-module id="nuxeo-campaign-metadata-layout">
    <template>
        <style>
            *[role=widget] {
                padding: 5px;
            }
            .account-view-layout {
                height: 32px;
                width: 32px;
                border-radius: 0px;
                box-sizing: border-box;
                margin-right: 8px;
            }
            .title{
                color:var(--nuxeo-secondary-color);
            }
            paper-card {
               display: inline-flex;
               box-sizing: border-box;
               margin-left: 8px;
               width: 250px;
            }

        </style>
        <div role="widget" class="title">
            <h1>
                [[document.properties.dc:title]]
            </h1>
            <!-- Top 10 creators -->
            <nuxeo-repository-data ecm-primary-type="Interaction"
                                   where="[[_setWhereTerm(document.uid)]]"
                                   grouped-by="interaction:statusMail"
                                   data="{{data}}"
            >
            </nuxeo-repository-data>
            <div class="card-content" style="float:right">
                <chart-pie values="[[_values(data)]]"
                           series="[[_series(data)]]"
                           labels="[[_labels(data)]]"
                           colors="[[colors]]"
                           options='{"responsive": true, "animation": false}'>
                </chart-pie>
            </div>
        </div>
        <div role="widget" hidden$="[[!document.properties.campaign:automationId]]" style="width:60%;">
            <label>[[i18n('label.metadata.automation.title')]]</label>
            <qualitified-document-suggestion role="widget"
                                             value="[[document.properties.campaign:automationId]]"
                                             min-chars="0"
                                             clickable="true"
                                             readOnly>
            </qualitified-document-suggestion>
        </div>
        <div role="widget" hidden$="[[!document.properties.campaign:status]]" style="width:60%;">
            <label>[[i18n('label.metadata.status')]]</label>
            <nuxeo-directory-suggestion role="widget"
                                        value="[[document.properties.campaign:status]]"
                                        directory-name="StatusCampaign"
                                        min-chars="0"
                                        readOnly>
            </nuxeo-directory-suggestion>
        </div>
        <div role="widget">
            <label>[[i18n('label.metadata.campaign.sendDate')]]</label>
            <div>[[formatDate(document.properties.campaign:sendDate)]]</div>
        </div>

        <nuxeo-repository-data data="{{sentCount}}"
                               ecm-primary-type="Interaction"
                               index="[[index]]" metrics="sum(interaction:isSent)"
                               where="[[_setWhereTerm(document.uid)]]">
        </nuxeo-repository-data>

        <nuxeo-repository-data data="{{deliveredCount}}"
                               ecm-primary-type="Interaction"
                               index="[[index]]" metrics="sum(interaction:isDelivered)"
                               where="[[_setWhereTerm(document.uid)]]">
        </nuxeo-repository-data>

        <nuxeo-repository-data data="{{openedCount}}"
                               ecm-primary-type="Interaction"
                               index="[[index]]" metrics="sum(interaction:isOpened)"
                               where="[[_setWhereTerm(document.uid)]]">
        </nuxeo-repository-data>

        <nuxeo-repository-data data="{{clickedCount}}"
                               ecm-primary-type="Interaction"
                               index="[[index]]" metrics="sum(interaction:isClicked)"
                               where="[[_setWhereTerm(document.uid)]]">
        </nuxeo-repository-data>

        <div class="horizontal justified">
            <paper-card>
                <table border="0" cellpadding="0" cellspacing="0" width="100%">
                    <tbody>
                    <tr>
                        <td>
                            <div style="display:block;text-align:center;background-color:white;padding-top:25px">
                                <div style="display:inline-block;width:14px;height:14px;border-radius:40px;background-color:#c7e3ff">

                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" style="background:white;font-size:0px;padding:5px;word-break:break-word">
                            <div style="font-family:Roboto,Helvetica,Arial;font-size:32px;font-weight:bold;line-height:40px;text-align:center;color:#555555">
                                [[sentCount]]
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" style="background:white;font-size:0px;padding:0px 25px;word-break:break-word">
                            <div style="font-family:Roboto,Helvetica,Arial;font-size:14px;line-height:20px;text-align:center;color:#888888">
                                Emails
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" style="background:white;font-size:0px;padding:10px 25px;word-break:break-word">
                            <div style="font-family:Roboto,Helvetica,Arial;font-size:16px;font-weight:bold;line-height:24px;text-align:center;color:#555555">
                                SENT
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </paper-card>
            <paper-card>
                <table border="0" cellpadding="0" cellspacing="0" width="100%">
                    <tbody>
                    <tr>
                        <td>
                            <div style="display:block;text-align:center;background-color:white;padding-top:25px">
                                <div style="display:inline-block;width:14px;height:14px;border-radius:40px;background-color:#c5baff">

                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" style="background:white;font-size:0px;padding:5px;word-break:break-word">
                            <div style="font-family:Roboto,Helvetica,Arial;font-size:32px;font-weight:bold;line-height:40px;text-align:center;color:#555555">
                                [[deliveredCount]]
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" style="background:white;font-size:0px;padding:0px 25px;word-break:break-word">
                            <div style="font-family:Roboto,Helvetica,Arial;font-size:14px;line-height:20px;text-align:center;color:#888888">
                                [[_getPartialPercent(deliveredCount,sentCount)]]%
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" style="background:white;font-size:0px;padding:10px 25px;word-break:break-word">
                            <div style="font-family:Roboto,Helvetica,Arial;font-size:16px;font-weight:bold;line-height:24px;text-align:center;color:#555555">
                                DELIVERED
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </paper-card>
            <paper-card>
                <table border="0" cellpadding="0" cellspacing="0" width="100%">
                    <tbody>
                    <tr>
                        <td>
                            <div style="display:block;text-align:center;background-color:white;padding-top:25px">
                                <div style="display:inline-block;width:14px;height:14px;border-radius:40px;background-color:#39e6ac">

                                </div>
                            </div>
                        </td>
                    </tr>

                    <tr>
                        <td align="center" style="background:white;font-size:0px;padding:5px;word-break:break-word">
                            <div style="font-family:Roboto,Helvetica,Arial;font-size:32px;font-weight:bold;line-height:40px;text-align:center;color:#555555">
                                [[_getPartialPercent(openedCount,sentCount)]]%
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" style="background:white;font-size:0px;padding:0px 25px;word-break:break-word">
                            <div style="font-family:Roboto,Helvetica,Arial;font-size:14px;line-height:20px;text-align:center;color:#888888">
                                [[openedCount]]
                            </div>
                        </td>
                    </tr>

                    <tr>
                        <td align="center" style="background:white;font-size:0px;padding:10px 25px;word-break:break-word">
                            <div style="font-family:Roboto,Helvetica,Arial;font-size:16px;font-weight:bold;line-height:24px;text-align:center;color:#555555">
                                OPENED
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </paper-card>
            <paper-card>
                <table border="0" cellpadding="0" cellspacing="0" width="100%">
                    <tbody>
                    <tr>
                        <td>
                            <div style="display:block;text-align:center;background-color:white;padding-top:25px">
                                <div style="display:inline-block;width:14px;height:14px;border-radius:40px;background-color:#ffaef1">

                                </div>
                            </div>
                        </td>
                    </tr>


                    <tr>
                        <td align="center" style="background:white;font-size:0px;padding:5px;word-break:break-word">
                            <div style="font-family:Roboto,Helvetica,Arial;font-size:32px;font-weight:bold;line-height:40px;text-align:center;color:#555555">
                                [[_getPartialPercent(clickedCount,sentCount)]]%
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" style="background:white;font-size:0px;padding:0px 25px;word-break:break-word">
                            <div style="font-family:Roboto,Helvetica,Arial;font-size:14px;line-height:20px;text-align:center;color:#888888">
                                [[clickedCount]]
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" style="background:white;font-size:0px;padding:10px 25px;word-break:break-word">
                            <div style="font-family:Roboto,Helvetica,Arial;font-size:16px;font-weight:bold;line-height:24px;text-align:center;color:#555555">
                                CLICKED
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </paper-card>
        </div>
    </template>
    <script>
    (function() {
      'use strict';
        Polymer({
            is: 'nuxeo-campaign-metadata-layout',
            behaviors: [Nuxeo.LayoutBehavior, Nuxeo.ChartDataBehavior],
            properties: {
                /**
                 * @doctype campaign
                 */
                document: {
                    type: Object,
                    observer: '_documentReady'
                },
                colors: {
                    type: Array,
                    value: ['#E67E22', '#F6DDCC', '#ffffb3', '#bebada', '#80b1d3', '#fdb462', '#b3de69', '#fccde5', '#d9d9d9', '#bc80bd']
                }
            },
            _documentReady: function(doc){
            },

            _getPartialPercent: function(partialCount,totalCount){
            var count = (partialCount * 100)/totalCount;
            if (count == 100) {
            return count;
            }
            return count.toFixed(2);
            },
            _setWhereTerm: function (campaignId) {
              if (campaignId) {
                var where1 = {};
                var where2 = {};
                var term1 = {};
                var term2 = {};
                var must = [];
                where1["interaction:campaignId"] = campaignId;
                where2["ecm:isTrashed"] = "false";
                term1["term"] = where1;
                term2["term"] = where2;
                must=[term1,term2];
                console.log(must);
                return must;
              }
              return "";
            }
        });
      })();
    </script>
</dom-module>