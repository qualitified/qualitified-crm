<link href="../qualitified-custom-fields.html" rel="import">
<dom-module id="nuxeo-campaign-view-layout">
    <template>
        <style include="nuxeo-styles shared-css">
            *[role=widget] {
                padding: 5px;
            }

            nuxeo-data-table {
                height: 100%;
            }

            .dataTable{
                /*height: 300px;*/
            }

            .queue-thumbnail {
                height: 32px;
                width: 32px;
                border-radius: 20px;
                box-sizing: border-box;
                margin-right: 8px;
            }

            .queue-thumbnail ::content img {
                height: 32px;
                width: 32px;
                border-radius: 20px;
                box-sizing: border-box;
                margin-right: 8px;
            }
            .results {
                @apply(--layout-vertical);
                @apply(--layout-flex);
                /* min-height: calc(60vh - 14em); */
                /*margin-top: 8px;*/
            }


        </style>




        <div class="dataTable">
            <nuxeo-page-provider id="contactProvider"
                                 query="select * from Contact where ecm:currentLifeCycleState != 'deleted' and ecm:isTrashed = 0 and ecm:parentId = '[[document.uid]]' "
                                 page-size="40"
                                 aggregations="{{contactAggregations}}"
                                 enrichers="thumbnail, permissions"
                                 page="[[pageNumber]]"
                                 params="[[params]]"
                                 schemas="person,dublincore,common,uid,file"
                                 headers='{"X-NXfetch.document": "properties", "X-NXtranslate.directoryEntry": "label"}'
                                 fetch-aggregates>
            </nuxeo-page-provider>

            <nuxeo-results name="[[document.uid]]" nx-provider="[[contactProvider]]" selected-items="{{selectedItems}}">
                <!-- <div class="selectionActions">
                  <nuxeo-slot slot="BROWSE_ACTIONS" model="[[browseActionContext]]"></nuxeo-slot>
                </div> -->


                <!-- Table view -->
                <nuxeo-data-table class="results" name="table" icon="nuxeo:view-list"
                                  settings-enabled
                                  empty-label="[[emptyLabel]]"
                                  empty-label-when-filtered="[[emptyLabelWhenFiltered]]"
                                  selection-enabled
                                  display-quick-filters
                                  on-row-clicked="_navigate">

                    <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.title')]]"
                                             field="dc:title" sort-by="dc:title" filter-by="title"  flex="100">
                        <template>
                            <img class="queue-thumbnail" src="[[_thumbnail(item)]]">
                            <a class="title ellipsis" href$="#!/browse[[item.path]]" on-tap="_navigate">[[item.title]]</a>
                        </template>
                    </nuxeo-data-table-column>

                    <nuxeo-data-table-column name="Role" field="person:Role" sort-by="person:Role" flex="60">
                        <template>
                            [[formatDirectory(item.properties.person:Role)]]
                        </template>
                    </nuxeo-data-table-column>

                    <nuxeo-data-table-column name="E-mail"  field="person:email" sort-by="person:email" flex="100">
                        <template>
                            [[item.properties.person:email]]
                        </template>
                    </nuxeo-data-table-column>

                    <nuxeo-data-table-column name="Phone_Number" field="person:phoneNumber" sort-by="person:phoneNumber"
                                             flex="60">
                        <template>
                            [[item.properties.person:phoneNumber]]
                        </template>
                    </nuxeo-data-table-column>

                    <nuxeo-data-table-column name="Modified" field="dc:modified" sort-by="dc:modified" flex="60">
                        <template>
                            [[formatDate(item.properties.dc:modified)]]
                        </template>
                    </nuxeo-data-table-column>

                    <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.lastContributor')]]"
                                             filter-by="dc_last_contributor_agg" field="dc:lastContributor" sort-by="dc:lastContributor" flex="50" hidden>
                        <template is="header">
                            <nuxeo-dropdown-aggregation
                                    placeholder="[[i18n('documentContentView.datatable.header.lastContributor')]]"
                                    data="[[contactAggregations.dc_last_contributor_agg]]"
                                    value="{{column.filterValue}}" multiple>
                            </nuxeo-dropdown-aggregation>
                        </template>
                        <template>
                            <nuxeo-user-tag user="[[item.properties.dc:lastContributor]]"></nuxeo-user-tag>
                        </template>
                    </nuxeo-data-table-column>
                </nuxeo-data-table>
            </nuxeo-results>
        </div>
    </template>

    <script>
        (function() {
            'use strict';
            Polymer({
                is: 'nuxeo-campaign-view-layout',

                behaviors: [Nuxeo.LayoutBehavior],
                properties: {

                    /**
                     * @doctype Campaign
                     */
                    document: {
                        type: Object
                    },

                    params: {
                        type: Object,
                        value: {},
                        notify: true
                    }
                },
                observers: [
                    '_refresh(params)',
                    '_observeDocument(document)'
                ],
                ready: function() {
                    this.selected = 0;
                    if (this.document) {
                        this.params = {'ecm_parentId': this.document.uid};
                    }

                    this.contactProvider = this.$.contactProvider;

                    this.documentProvider = this.$.documentProvider;
                },
                _observeDocument: function() {
                    if (this.document) {
                        this.params = {'ecm_parentId': this.document.uid};
                    }
                },
                _refresh: function() {
                    this.$.contactProvider.page = 1;
                },
                _formatCurrency: function(val) {
                    if(val == null){
                        return "";
                    }
                    return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                },
                _navigate: function(e) {
                    var detail = {
                        doc: e.detail.item,
                    };
                    if(detail.doc){
                        page('/browse' + detail.doc.path);
                    }
                },
                _formatDate: function(date) {
                    return moment(date).format('MMMM D, YYYY');
                },
                _thumbnail: function(doc) {
                    if (doc && doc.uid) {
                        if (doc.contextParameters && doc.contextParameters.thumbnail.url) {
                            return doc.contextParameters.thumbnail.url;
                        } else {
                            var baseUrl = this.$.nxcon.url;
                            return baseUrl + '/api/v1/id/' + doc.uid + '/@rendition/thumbnail';
                        }
                    }
                },
                /**
                 * Returns the label for the given directory entry.
                 */
                formatDirectory: function(value) {
                    if (value && value['entity-type'] && value['entity-type'] === 'directoryEntry') {
                        if (value.properties && value.properties.label) {
                            return value.properties.label;
                        } else {
                            var label = 'label_' + ((window.nuxeo.I18n.language) ? window.nuxeo.I18n.language.split('-')[0] : 'en');
                            return value.properties[label] || value.properties['label_en']
                        }
                    } else {
                        return value;
                    }
                }
            });
        })();
    </script>
</dom-module>
