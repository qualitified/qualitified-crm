<link rel="import" href="../../elements/qualitified-time-picker.html">
<link rel="import" href="../qualitified-custom-fields.html">
<link rel="import" href="email-interaction-create-layout.html">
<link rel="import" href="meeting-call-interaction-create-layout.html">


<dom-module id="nuxeo-interaction-create-layout">
  <template>
    <style include="nuxeo-styles">
      *[role=widget] {
        padding: 5px;
      }

      .dateFields {
        align-items: start;
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
      }
    </style>
    <nuxeo-connection id="nx" user="{{currentUser}}">
    </nuxeo-connection>
    <nuxeo-document id="parentDoc" auto doc-id="[[document.parentRef]]" enrichers="permissions, subtypes" response="{{parentDoc}}">
    </nuxeo-document>
    <nuxeo-directory-suggestion id="IntActivity" hidden$="[[isOppActivity]]" role="widget"
                                value="{{document.properties.interaction:activity}}" on-value-changed="_wichActivityLayout"
                                label="[[i18n('label.metadata.activity')]]" required="true" directory-name="IntActivity" min-chars="0">
    </nuxeo-directory-suggestion>
    <template is="dom-if" if="[[isDefaultLayout]]">
      <nuxeo-input role="widget" value="{{document.properties.dc:title}}"
                   label="[[i18n('label.metadata.interaction.title')]]" required="true">
      </nuxeo-input>

      <nuxeo-textarea role="widget" value="{{document.properties.dc:description}}"
                      label="[[i18n('label.metadata.interaction.description')]]">
      </nuxeo-textarea>

      <nuxeo-directory-suggestion role="widget" value="{{document.properties.interaction:status}}"
                                  label="[[i18n('label.metadata.status')]]" required="true" directory-name="IntStatus" min-chars="0">
      </nuxeo-directory-suggestion>

      <qualitified-user-suggestion role="widget" id="IntResponsible" value="{{document.properties.interaction:responsible}}"
                             label="[[i18n('label.metadata.responsible')]]" search-type="USER_TYPE" min-chars="0" multiple="true">
      </qualitified-user-suggestion>

      <qualitified-document-suggestion id="IntContact" role="widget" value="{{document.properties.interaction:contact}}"
                                       multiple="true" label="[[i18n('label.metadata.contact')]]" page-provider="documents" min-chars="0"
                                       params='{ "namedParameters": "system_primaryType=Contact"}'>
      </qualitified-document-suggestion>

      <nuxeo-date-picker value="{{document.properties.interaction:date}}" label="[[i18n('label.metadata.date')]]"
                         role="widget" required>
      </nuxeo-date-picker>
    </template>

    <template is="dom-if" if="[[isEmailLayout]]">
      <email-interaction-create-layout document="[[document]]" responsible="{{responsible}}">
      </email-interaction-create-layout>
    </template>
    <template is="dom-if" if="[[isEventLayout]]">
      <meeting-call-interaction-create-layout document="[[document]]">
      </meeting-call-interaction-create-layout>
    </template>

  </template>

  <script>
    (function () {
      'use strict';
      Polymer({
        is: 'nuxeo-interaction-create-layout',
        behaviors: [Nuxeo.LayoutBehavior],
        properties: {

          /**
             * @doctype Interaction
             */
          document: {
            type: Object,
            observer: '_documentReady'
          },
          currentUser: {
            type: Object,
            observer: '_initResponsible'
          },
          parentDoc: {
            type: Object,
            observer: '_initContact'
          },
          isDefaultLayout: {
            type: Boolean,
            value: true
          },
          isEmailLayout: {
            type: Boolean,
            value: false
          },
          isEventLayout: {
            type: Boolean,
            value: false
          },
          isOppActivity: {
            type: Boolean,
            value: false
          }

        },

        _documentReady: function () {
            if (this.document) {
              var currentDate = new Date().toISOString();
              this.set('document.properties.interaction:status', "TODO");
              this.set('document.properties.interaction:date', currentDate);
            }
        },

        _initResponsible: function () {
          this.set('document.properties.interaction:responsible', [this.currentUser.id]);
        },
        _initContact: function () {
          if (this.parentDoc) {
            var mainContact = null;
            if (this.parentDoc.type == 'Opportunity' && this.parentDoc.properties["opportunity:mainContact"] !== null ){
              mainContact = this.parentDoc.properties["opportunity:mainContact"];
            } else if (this.parentDoc.type == 'Account' && this.parentDoc.properties["account:mainContact"] !== null){
              mainContact = this.parentDoc.properties["account:mainContact"];
            }
            this.set('document.properties.interaction:contact', [mainContact]);
          }
        },
        _wichActivityLayout: function () {
          var activity = this.$.IntActivity.value;
          if (activity === "Email") {
            this.isDefaultLayout = false;
            this.isEmailLayout = true;
            this.isEventLayout = false;
          } else if (activity === "Call" || activity === "Meeting") {
            this.isDefaultLayout = false;
            this.isEmailLayout = false;
            this.isEventLayout = true;
          } else {
            this.isDefaultLayout = true;
            this.isEmailLayout = false;
            this.isEventLayout = false;
          }
        },

        _initOppActivityLayout: function (activity) {
          this.set('document.properties.interaction:activity', activity);
          this.isOppActivity = true;
          if (activity === 'Email') {
            this.isEmailLayout = true;
            this.isDefaultLayout = false;
          } else if (activity === 'Call' || activity === 'Meeting') {
            this.isEventLayout = true;
            this.isDefaultLayout = false;
          } else {
            this.isDefaultLayout = true;
          }
        },

        validate() {
          if (this.document.properties['dc:title']) {
            var title = this.document.properties['dc:title'].trim();
            this.set('document.properties.dc:title', title);
          }
          return true;
        }
      });
    })();
  </script>
</dom-module>