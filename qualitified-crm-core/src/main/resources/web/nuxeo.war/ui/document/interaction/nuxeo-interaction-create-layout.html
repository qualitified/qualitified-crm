<link rel="import" href="../../elements/qualitified-time-picker.html">
<link rel="import" href="../qualitified-custom-fields.html">

<dom-module id="nuxeo-interaction-create-layout">
  <template>
    <style include="nuxeo-styles">
      *[role=widget] {
        padding: 5px;
      }

      .dateFields {
        align-items: start;
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
      }
    </style>

    <paper-toast id="operationToast"></paper-toast>
    <nuxeo-resource id="tokens" path="oauth2/token/"></nuxeo-resource>
    <nuxeo-resource id="oauth" path="oauth2/provider/"></nuxeo-resource>
    <nuxeo-operation id="getCurrentUser" op="User.Get"></nuxeo-operation>
    <nuxeo-operation id="getContactDoc" op="Repository.GetDocument"></nuxeo-operation>

    <nuxeo-input role="widget" 
                 value="{{document.properties.dc:title}}"
                 label="[[i18n('label.metadata.interaction.title')]]">
    </nuxeo-input>

    <template is="dom-if" if="[[!_isActivityEmail(document.properties.interaction:activity)]]">
      <nuxeo-textarea role="widget" 
                      value="{{document.properties.dc:description}}"
                      label="[[i18n('label.metadata.interaction.description')]]">
      </nuxeo-textarea>
    </template>

    <template is="dom-if" if="[[_isActivityEmail(document.properties.interaction:activity)]]">
      <nuxeo-textarea role="widget" 
                      value="{{document.properties.note:note}}"
                      label="[[i18n('label.metadata.interaction.description')]]">
      </nuxeo-textarea>
    </template>

    <nuxeo-directory-suggestion role="widget" 
                                value="{{document.properties.interaction:status}}"
                                label="[[i18n('label.metadata.status')]]" 
                                required="true" 
                                directory-name="IntStatus" 
                                min-chars="0">
    </nuxeo-directory-suggestion>

    <nuxeo-directory-suggestion id="IntActivity" 
                                role="widget" value="{{document.properties.interaction:activity}}"
                                on-value-changed="_isActivity" 
                                label="[[i18n('label.metadata.activity')]]" 
                                required="true"
                                directory-name="IntActivity" 
                                min-chars="0">
    </nuxeo-directory-suggestion>

    <nuxeo-user-suggestion role="widget"
                           value="{{document.properties.interaction:responsible}}" 
                           on-value-changed="_isCurrentUser"
                           label="[[i18n('label.metadata.responsible')]]" 
                           search-type="USER_TYPE" 
                           min-chars="0"
                           multiple="true">
    </nuxeo-user-suggestion>

    <qualitified-document-suggestion role="widget" 
                                     value="{{document.properties.interaction:contact}}" 
                                     multiple="true"
                                     label="[[i18n('label.metadata.contact')]]" 
                                     page-provider="documents" 
                                     min-chars="0"
                                     params='{ "namedParameters": "system_primaryType=Contact"}'>
    </qualitified-document-suggestion>

    <div hidden$="[[!isEmailNull]]">
      <h style="color:red;">Please check contact's emails!</h><br />
    </div>

    <div class="dateFields">
      <qualitified-time-picker value="{{document.properties.interaction:date}}" 
                               display-duration="{{isSynchBtnChecked}}"
                               duration="{{document.properties.custom:stringField3}}" 
                               date-label="Date" 
                               duration-label="Duration"
                               role="widget">
      </qualitified-time-picker>
      <div hidden$="[[isHidden]]">
        <h style="color:red;">Date is required to enable synchronization!</h><br />
      </div>
    </div>

    <template is="dom-if" if="[[isEvent]]">
      <paper-toggle-button id="synchBtn" on-tap="_checkDateFields" on-change="_handleAuth" checked="{{isSynchBtnChecked}}">
        Synchronize with google calendar
      </paper-toggle-button>
    </template>

    <template is="dom-if"
              if="[[_canSend(document.properties.interaction:activity,document.properties.interaction:responsible)]]">
      <paper-toggle-button id="emailBtn" on-tap="_validateSend" checked="{{isEmailBtnChecked}}">Send email
      </paper-toggle-button>
    </template>

    <qualitified-custom-fields document="{{document}}" mode="edit"></qualitified-custom-fields>

    <nuxeo-dialog id="dialog" with-backdrop="" on-iron-overlay-closed="" no-auto-focus="">
      <h2>Synchronize with google calendar</h2>
      <div class="content">
        <h style="color:red;">To enable synchronization! please connect to your google account and try again.</h><br />
      </div>
      <div class="buttons">
        <paper-button dialog-dismiss="" noink="">Cancel</paper-button>
        <paper-button class="primary" name="add" on-click="_toggleWindow">
          Connect to google
        </paper-button>
      </div>
    </nuxeo-dialog>

  </template>

  <script>
    (function () {
      'use strict';
      Polymer({
        is: 'nuxeo-interaction-create-layout',
        behaviors: [Nuxeo.LayoutBehavior],
        properties: {

          /**
             * @doctype Interaction
             */
          document: {
            type: Object
          },
          displayDuration: {
            type: Boolean,
            value: false
          },
          isEvent: {
            type: Boolean,
            value: false
          },
          isSynchBtnChecked: {
            type: Boolean,
            value: false
          },
          authURL: {
            type: String
          },
          currentUser: {
            type: Boolean,
            value: false
          },
          isMeeting: {
            type: Boolean,
            value: false
          },
          isHidden: {
            type: Boolean,
            value: true
          },
          isEmailNull: {
            type: Boolean,
            value: false
          },
          isEmailBtnChecked: {
            type: Boolean,
            value: false
          },
          contactsEmail: {
            type: Array,
            value: []
          }

        },
        attached() {
          this.$.getCurrentUser.execute().then(function (result) {
            this.currentUser = result.title;
          }.bind(this));
        },
        _isActivity: function (e) {
          if (this.document) {
            var responsible = this.document.properties['interaction:responsible'];
            if ((e.detail.value === "Meeting" || e.detail.value === "Call") && JSON.stringify(responsible) === JSON.stringify([this.currentUser])) {
              this.isEvent = true;
            } else this.isEvent = false;
          }
        },
        _isCurrentUser: function (e) {
          if (this.document) {
            var activity = this.document.properties['interaction:activity'];
            if (JSON.stringify(e.detail.value) === JSON.stringify([this.currentUser]) && (activity === "Meeting" || activity === "Call")) {
              this.isEvent = true;
            } else this.isEvent = false;
          }
        },
        _isActivityEmail: function (activity) {
          return activity === 'Email' ? true : false;
        },
        _canSend: function (activity, currentUser) {
          if (this.document) {
            //var activity = this.document.properties['interaction:activity'];
            if (activity === "Email" && currentUser.length === 1 && this.currentUser === currentUser[0]) {
              return true
            } else return false;
          }
        },

        _validateSend: async function () {
          if (this.isEmailBtnChecked === true) {
            var contacts = this.document.properties['interaction:contact'];
            var op = this.$.getContactDoc;
            var contactsEmails = [];
            for (const contactId of contacts) {
              op.params = {
                'value': contactId
              };
              var contactEmail = await op.execute().then(function (result) {
                return result.properties['person:email'];
              });
              contactsEmails.push(contactEmail);
            };
            this._validateContactsEmail(contactsEmails);
          }
        },

        _validateContactsEmail: function (contactsEmails) {
          if (contactsEmails.indexOf(null) !== -1) {
            this.isEmailNull = true;
            this.isEmailBtnChecked = false;
          } else {
            this.isEmailNull = false;
            this.isEmailBtnChecked = true;
          }
        },

        _checkDateFields: function () {
          if (this.document) {
            var startDte = this.document.properties['interaction:date'];
            if (this.isSynchBtnChecked === true) {
              if (startDte) {
                this.isHidden = true;
                return true;
              } else {
                this.isHidden = false;
                this.isSynchBtnChecked = false;
                return false;
              }
            }
          }
        },

        _handleAuth: function (e) {
          if (this._checkDateFields()) {
            this.set('document.properties.custom:stringField3', "15");
            this.$.oauth.get().then(function (response) {
              if (response.entries && response.entries.length > 0)
                console.log(response.entries);
              response.entries.forEach(serviceProvider => {
                if (serviceProvider.serviceName === "googleCalendar") {
                  this.authURL = serviceProvider.authorizationURL;
                  if (serviceProvider.isAuthorized === true) {
                    this.$.operationToast.text = "Synch is on!";
                    this.$.operationToast.open();
                    this.document.properties['custom:booleanField1'] = this.isSynchBtnChecked;
                  } else {
                    this.isSynchBtnChecked = false;
                    this.$.dialog.toggle();
                  }
                }
              });
            }.bind(this));
          }
        },
        _toggleWindow: function () {
          //var redirect_uri = document.location.origin+"/nuxeo/site/oauth2/docusign/callback";
          var googleAuthWindow = window.open(this.authURL, "google oauth2", "resizable,scrollbars,status,width=800,height=800");
          this.$.dialog.toggle();
        },

        validate() {
          if (this.document.properties['interaction:activity'] === 'Meeting' ) {
            this.set('document.properties.custom:booleanField1', this.isSynchBtnChecked);
          }
          if (this.document.properties['interaction:activity'] === 'Email' ) {
            this.set('document.properties.custom:booleanField2', this.isEmailBtnChecked);
          }
          if (this.isChecked === false) {
            this.set('document.properties.custom:stringField3', null);
          }
          if (this.document.properties['dc:title']) {
            var title = this.document.properties['dc:title'].trim();
            this.set('document.properties.dc:title', title);
          }
          return true;
        }
      });
    })();
  </script>
</dom-module>