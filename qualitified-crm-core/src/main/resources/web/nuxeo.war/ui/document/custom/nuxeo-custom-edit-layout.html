<!--
`nuxeo-account-edit-layout`
@group Nuxeo UI
@element nuxeo-account-edit-layout
-->
<dom-module id="nuxeo-custom-edit-layout">
  <template>
    <style>
      *[role=widget] {
        padding: 5px;
      }
      .results {
        @apply(--layout-vertical);
        @apply(--layout-flex);
        min-height: calc(100vh - 14em);
        margin-top: 8px;
      }
      .container {
        overflow: auto;
        flex: 1 1 auto;
        height: 400px;
      }
      .paper-item{
      background: var(--nuxeo-primary-color);}

      .paper-listbox{
      padding: 20px;}
      .label {
        display: var(--nuxeo-label_-_display);
        opacity: var(--nuxeo-label_-_opacity);
        white-space: var(--nuxeo-label_-_white-space);
        overflow: var(--nuxeo-label_-_overflow);
        text-overflow: var(--nuxeo-label_-_text-overflow);
        font-weight: var(--nuxeo-label_-_font-weight) !important;
        letter-spacing: var(--nuxeo-label_-_letter-spacing) !important;
    }

    </style>
    <h1>[[document.properties.dc:title]]</h1>
    <div class="vertical layout">
      <nuxeo-resource auto on-response="_handleDocTypes" path="config/types/"></nuxeo-resource>

      <div class="layout horizontal center end-justified" style="float: right;">
        <paper-button class="primary" id="addEntry" on-tap="_addEntry">
          <span>Add</span>
        </paper-button>
      </div>
      <nuxeo-data-table class="results" id="customTable" items="{{document.properties.custom:field}}" role="widget">
        <nuxeo-data-table-column name="[[i18n('label.metadata.custom.label')]]">
          <template>
            <div>{{item.label}}</div>
          </template>
        </nuxeo-data-table-column>
        <nuxeo-data-table-column name="[[i18n('label.metadata.custom.type')]]">
          <template>
            <div>{{item.type}}</div>
          </template>
        </nuxeo-data-table-column>
        <nuxeo-data-table-column name="[[i18n('label.metadata.custom.fieldname')]]">
          <template>
            <div>{{item.fieldName}}</div>
          </template>
        </nuxeo-data-table-column>
        <nuxeo-data-table-column name="[[i18n('label.metadata.custom.required')]]">
          <template>
            <div>[[item.required]]</div>
          </template>
        </nuxeo-data-table-column>
        <nuxeo-data-table-column name="[[i18n('label.metadata.custom.vocabularyname')]]">
          <template>
            <div>[[item.vocabularyName]]</div>
          </template>
        </nuxeo-data-table-column>
        <nuxeo-data-table-column name="[[i18n('label.metadata.custom.format')]]">
          <template>
            <div>[[item.format]]</div>
          </template>
        </nuxeo-data-table-column>
        <nuxeo-data-table-column name="[[i18n('label.metadata.custom.readgroup')]]">
          <template>
            <div>[[item.readGroup]]</div>
          </template>
        </nuxeo-data-table-column>
        <nuxeo-data-table-column name="[[i18n('label.metadata.custom.editgroup')]]">
          <template>
            <div>[[item.editGroup]]</div>
          </template>
        </nuxeo-data-table-column>
        <nuxeo-data-table-column name="[[i18n('label.metadata.custom.hiddengroup')]]">
          <template>
            <div>[[item.hiddenGroup]]</div>
          </template>
        </nuxeo-data-table-column>
        <!--nuxeo-data-table-column name="[[i18n('label.metadata.custom.multivalue')]]">
          <template>
            <div>[[item.multivalue]]</div>
          </template>
        </nuxeo-data-table-column-->
        <nuxeo-data-table-column name="[[i18n('label.metadata.custom.primarytype')]]">
          <template>
            <div>[[item.primaryType]]</div>
          </template>
        </nuxeo-data-table-column>
        <nuxeo-data-table-column name="[[i18n('label.metadata.custom.path')]]">
          <template>
            <div>[[item.path]]</div>
          </template>
        </nuxeo-data-table-column>
        <nuxeo-data-table-column name="[[i18n('label.metadata.custom.parentid')]]">
          <template>
            <div>[[item.parentId]]</div>
          </template>
        </nuxeo-data-table-column>
        <!--nuxeo-data-table-column name="[[i18n('label.metadata.custom.multiline')]]">
          <template>
            <div>[[item.multiline]]</div>
          </template>
        </nuxeo-data-table-column-->
        <nuxeo-data-table-column name="[[i18n('label.metadata.custom.link')]]">
          <template>
            <div>[[item.link]]</div>
          </template>
        </nuxeo-data-table-column>
        <nuxeo-data-table-column name="[[i18n('label.metadata.custom.editable')]]">
          <template>
            <div>[[item.editable]]</div>
          </template>
        </nuxeo-data-table-column>
        <nuxeo-data-table-column name="[[i18n('label.metadata.custom.copy')]]">
          <template>
            <div>[[item.copy]]</div>
          </template>
        </nuxeo-data-table-column>
        <nuxeo-data-table-column name="[[i18n('label.metadata.custom.columns')]]">
          <template>
            <div>[[item.column]]</div>
          </template>
        </nuxeo-data-table-column>
        <nuxeo-data-table-column key="[[col.key]]" name="[[i18n(col.name)]]">
          <template>
            <paper-icon-button icon="nuxeo:edit" name="edit" on-tap="_editEntry" title="Edit"></paper-icon-button>
            <paper-icon-button icon="nuxeo:delete" name="delete" on-tap="_deleteEntry" title="Delete"></paper-icon-button>
          </template>
        </nuxeo-data-table-column>
      </nuxeo-data-table>
      <nuxeo-dialog id="dialog" no-auto-focus="" with-backdrop="">
        <h2>Edit</h2>
        <paper-dialog-scrollable>
          <iron-form id="form">
            <form>
              <nuxeo-input label="Label" role="widget" value="{{_selectedEntry.label}}"></nuxeo-input>
              <nuxeo-directory-suggestion directory-name="Type" label="Type"
                                          min-chars="0"
                                          name="Type"
                                          on-value-changed="_getVocabOnCreate"
                                          role="widget"  value="{{_selectedEntry.type}}">
              </nuxeo-directory-suggestion>
              <div class="label">FieldName</div>
              <paper-dropdown-menu id="field"  selectedItem="{{_selectedEntry.fieldName}}"
                                   style="width:100%;"
                                   value="{{_selectedEntry.fieldName}}">
                <paper-listbox class = "dropdown-content" slot="dropdown-content" style=" background-color: white; left: 509px; top: 146px; width: 422px;" >
                  <dom-repeat as="field" items="[[newList]]">
                    <template>
                      <paper-item  key="[[field.id]]">[[field.label]]</paper-item>
                    </template>
                  </dom-repeat>
                </paper-listbox>
              </paper-dropdown-menu><br>
              <paper-checkbox checked="{{_selectedEntry.required}}"></paper-checkbox> Required
              <nuxeo-input label="Vocabulary Name" role="widget" value="{{_selectedEntry.vocabularyName}}"></nuxeo-input>
              <div hidden$="[[!isHidden]]">
                <nuxeo-input  label="Format" role="widget" value="{{_selectedEntry.format}}"></nuxeo-input>
              </div>
              <nuxeo-user-suggestion label="Read Group" min-chars="0"
                                     placeholder="Search for Groups"
                                     role="widget"
                                     search-type="GROUP_TYPE"
                                     value="{{_selectedEntry.readGroup}}"></nuxeo-user-suggestion>
              <nuxeo-user-suggestion label="Edit Group" min-chars="0"
                                     placeholder="Search for Groups"
                                     role="widget"
                                     search-type="GROUP_TYPE"
                                     value="{{_selectedEntry.editGroup}}"></nuxeo-user-suggestion>
              <nuxeo-user-suggestion label="Hidden Group" min-chars="0"
                                     placeholder="Search for Groups"
                                     role="widget"
                                     search-type="GROUP_TYPE"
                                     value="{{_selectedEntry.hiddenGroup}}"></nuxeo-user-suggestion>
              <!--paper-checkbox checked="{{_selectedEntry.multivalue}}"></paper-checkbox> Multivalue <br><br-->
              <div hidden$="[[!hidden]]">

              <label>Primary Type</label>
              <nuxeo-selectivity data="[[docTypes]]"
                                 min-chars=0
                                 placeholder="[[i18n('templateRenderingPage.validDocTypes.placeholder')]]"
                                 value="{{_selectedEntry.primaryType}}" ></nuxeo-selectivity>

              <!--nuxeo-input role="widget" value="{{_selectedEntry.primaryType}}" label="Primary Type"></nuxeo-input-->
              <nuxeo-input label="Path" role="widget" value="{{_selectedEntry.path}}"></nuxeo-input>
                <nuxeo-input label="Parent Id" role="widget" value="{{_selectedEntry.parentId}}"></nuxeo-input></div>
              <!--paper-checkbox checked="{{_selectedEntry.multiline}}"></paper-checkbox> Multiline <br/-->
              <paper-checkbox checked="{{_selectedEntry.link}}"></paper-checkbox> Link <br/>
              <paper-checkbox checked="{{_selectedEntry.copy}}"></paper-checkbox> Copyable <br/>
              <paper-checkbox checked="{{_selectedEntry.editable}}"></paper-checkbox> Editable <br/>
              <!--nuxeo-directory-suggestion role="widget" value="{{document.properties.custom:columns}}"
                                          label="[[i18n('label.metadata.custom.columns')]]" directory-name="Columns"
                                          min-chars="0" ></nuxeo-directory-suggestion-->
              <nuxeo-directory-suggestion directory-name="Columns" label="[[i18n('label.metadata.custom.columns')]]"
                                          min-chars="0"
                                          name="Columns"
                                          on-value-changed="_getVocabOnCreate"
                                          role="widget"  value="{{_selectedEntry.column}}">
              </nuxeo-directory-suggestion>
            </form>
          </iron-form>
        </paper-dialog-scrollable>
        <div class="buttons">
          <paper-button dialog-dismiss="" id="cancel" name="cancel" noink="">[[i18n('command.cancel')]]</paper-button>
          <paper-button class="primary" id="save" name="save" noink="" on-tap="_save">[[i18n('command.save')]]</paper-button>
        </div>
      </nuxeo-dialog>
  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'nuxeo-custom-edit-layout',
        behaviors: [Nuxeo.LayoutBehavior],
        properties: {
          /**
           * @doctype Custom
           */
          document: {
            type: Object
          },
          vocabEntries:{
          type: Array,
          value: []
          },
          newList: {
          type: Array,
          value: []
          },
          isHidden: {
            type:Boolean
          },
          hidden: {
            type:Boolean
          },
          customFields: {
           type: Array,
           value: []
          },
          _selectedEntry: {
          type: Object
          },
          docTypes: Array,
          selectedIndex: {
            type: Number
          },
          _isNew: {
            type: Boolean
          }
        },

      _handleDocTypes: function(e) {
        var docTypes = [{
          id: 'all',
          text: this.i18n('templateRenderingPage.label.document.type.all'),
          displayLabel: this.i18n('templateRenderingPage.label.document.type.all')
        }];
        Object.keys(e.detail.response.doctypes).sort().forEach(function(docType) {
          docTypes.push({
            id: docType,
            text: docType,
            displayLabel: docType
          });
        });
        this.set('docTypes', docTypes);
      },
      /*attached: function () {
       if(this.$.field.detail.value=="Date"){
              this.isHidden=true;
            } else {
             this.isHidden=false;
            }
        },*/

      _getAvailableFields:function(onEdit){
      var newList=[];
      var vocabs=this.vocabEntries;
      var customField= this.document.properties["custom:field"];
      var fieldNameList=[];
      var field = this._selectedEntry.fieldName;
      console.log(field);
        if (onEdit == true) {
            newList.push({id:field,label:field});
          }
        for(var j=0;j<customField.length;j++){
          fieldNameList.push(customField[j].fieldName);
        }
        for(var i=0;i<vocabs.length;i++){
          if (fieldNameList.indexOf(vocabs[i].id) === -1) {
            newList.push({id:vocabs[i].id,label:vocabs[i].id});
          }
          else if (customField.indexOf(vocabs[i].id) > -1) {
            console.log(vocabs[i] + ' already exists in the customField collection.');
          }
        }
      this.newList=newList;
    },
    _getVocabOnCreate: function(e) {
      var onEdit= false;
      var selection= e.detail.value;
      this.$.field.setAttribute("directory-Name", selection);
      if(selection=="Date"){
        this.isHidden=true;
        }
      else {
         this.isHidden=false;
      }
      if(selection=="Document"){
      this.hidden=true;
        }
      else {
         this.hidden=false;
      }
      fetch(window.location.origin + '/nuxeo/api/v1/directory/'+selection)
      .then((resp) => resp.json())
      .then(function(data) {
      this.vocabEntries = data.entries;
      this._getAvailableFields(onEdit);
      }.bind(this));
    },
    _getVocabOnEdit: function(selectedType) {
      var onEdit= true;
      fetch(window.location.origin + '/nuxeo/api/v1/directory/'+selectedType)
      .then((resp) => resp.json())
      .then(function(data) {
      this.vocabEntries = data.entries;
      this._getAvailableFields(onEdit);
      }.bind(this));
    },
        _editEntry: function(e) {
            var item =  e.target.parentNode.item;
            this.selectedIndex = this.document.properties['custom:field'].indexOf(item);
            this._isNew = false;
            this._selectedEntry = JSON.parse(JSON.stringify(item));
            this._getVocabOnEdit(this._selectedEntry.type);
            console.log(this._selectedEntry);
            console.log(this.vocabEntries);
            this.$.dialog.toggle();
        },
        _addEntry: function() {
          this._isNew = true;
          this._selectedEntry = {
            "fieldName": null,
            "read": null,
            "hidden": null,
            "edit": null,
            "readGroup": null,
            "editGroup": null,
            "format": null,
            "link": null,
            "vocabularyName": null,
            "label": null,
            "type": null,
            "required": null,
            "parentId": null,
            "multivalue": null,
            "path": null,
            "hiddenGroup": null,
            "primaryType": null,
            "multiline": null,
            "copy": null,
            "editable": null,
            "column": null
          };
          this.$.dialog.toggle();
        },
        _save: function() {
          var valid = this.$.form.validate();
            if (this._isNew) {
              this._create(this._selectedEntry);
            } else {
              this._update(this._selectedEntry);
            }
        },
        _create: function(entry) {
         this.push('document.properties.custom:field',entry);
         this.$.dialog.toggle();
        },
        _update: function(entry) {
          this.splice('document.properties.custom:field',this.selectedIndex, 1, entry);
                                  console.log("entry  "+entry);
          this.$.dialog.toggle();
        },
        _deleteEntry: function(e) {
           var item =  e.target.parentNode.item;
           var selectedIndex = this.document.properties['custom:field'].indexOf(item);
           this.splice('document.properties.custom:field',selectedIndex, 1)
        }
      });
    })();
  </script>
</dom-module>