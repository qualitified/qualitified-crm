<link rel="import" href="../elements/qualitified-inline-edit.html">
<dom-module id="qualitified-pipeline">
  <template>
    <style include="nuxeo-styles grid-styles">
      :root {
        --empty-column-height: 500px;
      }
      #board {
         overflow: hidden;
         display: flex;
         min-height: 650px;

      }

      #board .column {
        width: 25%;
        position: relative;
        min-height: 650px;
        max-width: 25%;
       }

      #board .column:last-child {
        border-right-color: transparent;
      }

      #board .column.over, #board .column.over:last-child {
        border: dashed 1px #555;
        background-color: #efefef;
      }

      .drop {
        min-height: 500px;
        white-space: nowrap;
        margin-top: 50px;
        margin-right: 1vw;
      }
      .empty-column {
        min-height: 500px;
        white-space: nowrap;
        background-color: rgb(0 0 0 / 3%);
        border-radius: 12px;
        width: 86%;
        border-style: dashed;
        border-width: 1.95px;
        border-color: var(--nuxeo-secondary-color);
        margin-right: -6px;
        margin-top: 50px;
      }

      nuxeo-card {
        margin-bottom: 5px;
        margin-left: 5px;
        margin-right: 35px;
        border-radius: 12px;
        cursor: pointer;
      }

      .drag-icon{
        color: rgb(0 0 0 / 26%);
        width: 30px;
        height: 30px;
      }

      .footerContainer {
        position: fixed;
        bottom: 0px;
        width: 100%;
        height: 0px;
        bottom: +100px;
        margin-right: 100px;
        margin-left: 150px;

      }
      .scroll-box {
        overflow-x: auto;
        margin-top: 10px;
        max-height: 550px
      }

      .footer {
        width: 18%;
        height: 100px;
        float: left;
        color: #fff;
        font-weight: bold;
        position: relative;
        border-radius: 12px;
        bottom: -70px;
        display: flex;
        justify-content: center;
        z-index: 1;
      }
      .column-header{
        display: var(--layout-horizontal_-_display);
        -ms-flex-direction: var(--layout-horizontal_-_-ms-flex-direction);
        -ms-flex-align: var(--layout-center_-_-ms-flex-align);
        -webkit-align-items: var(--layout-center_-_-webkit-align-items);
        align-items: var(--layout-center_-_align-items);
        font-size: 1rem;
        height: 53px;
        text-transform: uppercase;
        width: 95%;
        text-overflow: ellipsis;
        color: var(--nuxeo-drawer-header);
        position: fixed;
        margin-left: -15px;
        background-color: #f5f5f6;
        z-index: +4;
        top: 54px;
      }

      .lost {
        background-color: #f44336;
      }

      .won {
        background-color: #8BC34A;
      }

      .nogo {
        background-color: #FF9800;
      }

      .limbo {
        background-color: #03A9F4;
      }

      .lostText {
        color: #f44336;
      }

      .wonText {
        color: #8BC34A;
      }

      .nogoText {
        color: #FF9800;
      }

      .limboText {
        color: #03A9F4;
      }

      .footerDrop {
        bottom: 0px;
      }

      iron-icon.icon {
        color: #fff;
        width: 6vw;
        height: 100px;
        position: absolute;
        margin-left: -3.9vw;
      }

      .slider {
        width: 100px;
        height: 20px;
        position: absolute;
        top: 10px;
        bottom: 0;
        left: 21px;
        transition: 1s ease;
      }

      .slide {
        top: -50px;
      }
      h4 {
        font-weight: 400;
        margin-left: 30px;
      }

      #editButton {
        width: 19px;
        padding: 0px;
        height: 19px;
        margin: -2px 6px;
      }

      .labelAction {
        display: inline-flex;
      }

    </style>
    <nuxeo-operation id="setProperty" op="Document.SetProperty" input="[[document]]"
                     params="[[params]]"></nuxeo-operation>
    <nuxeo-operation id="getOption" op="Qualitified.GetOptionValue"></nuxeo-operation>


    <paper-toast id="inlineToast"></paper-toast>


    <div id="board">
      <div class="column">
        <div class="column-header" id ="top" label="NEW">
          <h4>[[i18n('label.qualitified.pipeline.new')]]<br />[[_formatCurrency(newTotalAmount,currencyFormat,currency)]] </h4>
          <iron-icon class="icon" icon="icons:chevron-right"></iron-icon>
        </div>
        <!--         <div class="scroll-box">
         -->          <div id="new" class="drop">
        <template is="dom-repeat" items="[[itemsNew]]" >
          <nuxeo-card id="id[[item.uid]]" draggable="true" on-dragleave="dragLeave" on-dragend="dragend" on-dragstart="drag" class="card" draggable="true">
            <qualitified-inline-edit document="[[item]]" value="[[item.title]]" is-link label="[[i18n('label.dublincore.title')]]"></qualitified-inline-edit>
            <qualitified-inline-edit document="[[item]]" value="[[item.properties.opportunity:amount]]" metadata="amount" property="opportunity:amount" label="[[i18n('label.metadata.amount')]]"></qualitified-inline-edit>
            <qualitified-inline-edit document="[[item]]" value="[[item.properties.opportunity:responsible]]" property="opportunity:responsible" label="label.metadata.responsible"  metadata="user"></qualitified-inline-edit>
            <qualitified-inline-edit document="[[item]]" property="opportunity:closeDate" label="label.metadata.date" notify-value metadata="date"></qualitified-inline-edit>
          </nuxeo-card>
        </template>
      </div>
        <div id="dropInNew" hidden class="empty-column" on-drop="drop" on-dragend="dragend" on-dragleave="dragLeave" on-dragover="allowDrop" on-dragenter="dragenter">
        </div>
        <!--         </div>
         -->      </div>

      <div class="column">
        <div class="column-header" label="FIRST CONTACT/DEMO">
          <h4>[[i18n('label.qualitified.pipeline.first')]]<br />[[_formatCurrency(firstContactTotalAmount,currencyFormat,currency)]]</h4>
          <iron-icon class="icon" icon="icons:chevron-right"></iron-icon>
        </div>
        <!--         <div class="scroll-box">
         -->          <div id="first" class="drop">
        <template is="dom-repeat" items="[[itemsFirstContact]]">
          <nuxeo-card id="id[[item.uid]]" draggable="true"  on-dragleave="dragLeave" on-dragend="dragend" on-dragstart="drag"  class="card" draggable="true">
            <qualitified-inline-edit document="[[item]]" value="[[item.title]]" is-link label="[[i18n('label.dublincore.title')]]"></qualitified-inline-edit>
            <qualitified-inline-edit document="[[item]]" value="[[item.properties.opportunity:amount]]" metadata="amount" property="opportunity:amount" label="[[i18n('label.metadata.amount')]]"></qualitified-inline-edit>
            <qualitified-inline-edit document="[[item]]" value="[[item.properties.opportunity:responsible]]" property="opportunity:responsible" label="label.metadata.responsible"  metadata="user"></qualitified-inline-edit>
            <qualitified-inline-edit document="[[item]]" property="opportunity:closeDate" label="label.metadata.date" notify-value metadata="date"></qualitified-inline-edit>
          </nuxeo-card>
        </template>
      </div>
        <div id="dropInFirst" hidden class="empty-column" on-drop="drop" on-dragend="dragend" on-dragleave="dragLeave" on-dragover="allowDrop" on-dragenter="dragenter">
        </div>
        <!--         </div>
         -->      </div>

      <div class="column">
        <div class="column-header" label="PROPOSAL SENT">
          <h4>[[i18n('label.qualitified.pipeline.proposal')]]<br />[[_formatCurrency(proposalSentTotalAmount,currencyFormat,currency)]]</h4>
          <iron-icon class="icon" icon="icons:chevron-right"></iron-icon>
        </div>
        <!--         <div class="scroll-box">
         -->          <div id="proposal" class="drop">
        <template is="dom-repeat" items="[[itemsProposal]]">
          <nuxeo-card id="id[[item.uid]]" draggable="true"  on-dragleave="dragLeave" on-dragend="dragend" on-dragstart="drag" class="card" draggable="true">
            <qualitified-inline-edit document="[[item]]" value="[[item.title]]" is-link label="[[i18n('label.dublincore.title')]]"></qualitified-inline-edit>
            <qualitified-inline-edit document="[[item]]" value="[[item.properties.opportunity:amount]]" metadata="amount" property="opportunity:amount" label="[[i18n('label.metadata.amount')]]"></qualitified-inline-edit>
            <qualitified-inline-edit document="[[item]]" value="[[item.properties.opportunity:responsible]]" property="opportunity:responsible" label="label.metadata.responsible"  metadata="user"></qualitified-inline-edit>
            <qualitified-inline-edit document="[[item]]" property="opportunity:closeDate" label="label.metadata.date" notify-value metadata="date"></qualitified-inline-edit>
          </nuxeo-card>
        </template>
      </div>
        <div id="dropInProposal" hidden class="empty-column" on-drop="drop" on-dragend="dragend" on-dragleave="dragLeave" on-dragover="allowDrop" on-dragenter="dragenter">
        </div>
        <!--         </div>
         -->      </div>

      <div class="column">
        <div class="column-header" label="NEGOCIATION">
          <h4>[[i18n('label.qualitified.pipeline.negotiation')]]<br />[[_formatCurrency(negociationTotalAmount,currencyFormat,currency)]]</h4>
          <iron-icon class="icon" icon="icons:chevron-right"></iron-icon>
        </div>
        <!--         <div class="scroll-box">
         -->          <div id="nego" class="drop">
        <template is="dom-repeat" items="[[itemsNegociation]]">
          <nuxeo-card id="id[[item.uid]]" draggable="true"  on-dragleave="dragLeave" on-dragend="dragend" on-dragstart="drag"  class="card" draggable="true">
            <qualitified-inline-edit document="[[item]]" value="[[item.title]]" is-link label="[[i18n('label.dublincore.title')]]"></qualitified-inline-edit>
            <qualitified-inline-edit document="[[item]]" value="[[item.properties.opportunity:amount]]" metadata="amount" property="opportunity:amount" label="[[i18n('label.metadata.amount')]]"></qualitified-inline-edit>
            <qualitified-inline-edit document="[[item]]" value="[[item.properties.opportunity:responsible]]" property="opportunity:responsible" label="label.metadata.responsible"  metadata="user"></qualitified-inline-edit>
            <qualitified-inline-edit document="[[item]]" property="opportunity:closeDate" label="label.metadata.date" notify-value metadata="date"></qualitified-inline-edit>
          </nuxeo-card>
        </template>
      </div>
        <div id="dropInNego" hidden class="empty-column" on-drop="drop" on-dragend="dragend" on-dragleave="dragLeave" on-dragover="allowDrop" on-dragenter="dragenter">
        </div>
        <!--         </div>
         -->      </div>
      <div id="footerId" class="footerContainer">
        <div id="limbo" class="footer limbo" on-dragleave="dragLeave" on-drop="dropFooter" on-dragover="allowDropFooter">
          [[i18n('label.qualitified.pipeline.limbo')]]
          <span id="limboAmount" style="margin-left: 10px;" >[[_formatCurrency(limboAmount,currencyFormat,currency)]]</span>
          <div id="newlimboAmount" class="limboText slider">+ [[_formatCurrency(newlimboAmount,currencyFormat,currency)]]</div>
        </div>
        <div id="nogo" class="footer nogo" on-dragleave="dragLeave" on-drop="dropFooter" on-dragover="allowDropFooter">
          [[i18n('label.qualitified.pipeline.nogo')]]
          <span id="nogoAmount" style="margin-left: 10px;" >[[_formatCurrency(nogoAmount,currencyFormat,currency)]]</span>
          <div id="newnogoAmount" class="nogoText slider">+ [[_formatCurrency(newnogoAmount,currencyFormat,currency)]]</div>
        </div>
        <div id="won" class="footer won" on-dragleave="dragLeave" on-drop="dropFooter" on-dragover="allowDropFooter">
          [[i18n('label.qualitified.pipeline.won')]]
          <span id="wonAmount" style="margin-left: 10px;" >[[_formatCurrency(wonAmount,currencyFormat,currency)]]</span>
          <div id="newwonAmount" class="wonText slider">+ [[_formatCurrency(newwonAmount,currencyFormat,currency)]]</div>
        </div>
        <div id="lost" class="footer lost" on-dragleave="dragLeave" on-drop="dropFooter" on-dragover="allowDropFooter">
          [[i18n('label.qualitified.pipeline.lost')]]
          <span id="lostAmount" style="margin-left: 10px;" >[[_formatCurrency(lostAmount,currencyFormat,currency)]]</span>
          <div id="newlostAmount" class="lostText slider">+ [[_formatCurrency(newlostAmount,currencyFormat,currency)]]</div>
        </div>
      </div>
    </div>


  </template>
  <script>
    Polymer({
      is: 'qualitified-pipeline',
      behaviors: [Nuxeo.RoutingBehavior, Nuxeo.FormatBehavior, Nuxeo.ChartDataBehavior, Report.DataBehavior],
      properties: {
       document: {
      type: Object,
      },
      items: {
      type: Array,
      observer: "_filterByState",
      notify: true,
      },
      isDragged:{
      type: Boolean,
      value: true
      },
      params:{
      type: Object,
      value: {}
      },
       itemsNew: {
      type: Array,
      value:[]
      },
       itemsFirstContact: {
      type: Array,
      value:[]
      },
       itemsProposal: {
      type: Array,
      value:[]
      },
       itemsNegociation: {
      type: Array,
      value:[]
      },
      newTotalAmount: {
      type: Number,
      value:0
      },
      firstContactTotalAmount: {
      type: Number,
      value:0
      },
      proposalSentTotalAmount: {
      type: Number,
      value:0
      },
      negociationTotalAmount: {
      type: Number,
      value:0
      },
      limboAmount: {
      type: Number,
      value:0
      },
      nogoAmount: {
      type: Number,
      value:0
      },
      newnogoAmount: {
      type: Number,
      value:0
      },
      wonAmount: {
      type: Number,
      value:0
      },
      newwonAmount: {
      type: Number,
      value:0
      },
      lostAmount: {
      type: Number,
      value:0
      },
      newlostAmount: {
      type: Number,
      value:0
      },
      newlimboAmount: {
      type: Number,
      value:0
      },
      IdSelected: {
      type: String,
      },
      currencyFormat:{
        type: String
      },
      currency:{
        type: String
      }
      },

      _filterByState: function() {

        this.itemsNew=[];
        this.itemsFirstContact=[];
        this.itemsProposal=[];
        this.itemsNegociation=[];
        this.limboAmount=0;
        this.nogoAmount=0;
        this.wonAmount=0;
        this.lostAmount=0;
        this.newTotalAmount=0;
        this.firstContactTotalAmount=0;
        this.proposalSentTotalAmount=0;
        this.negociationTotalAmount=0;
       this.itemsNew = this.items.filter(function (el) {
       return el.properties['opportunity:step'].id =='New';
       });
       this.itemsFirstContact = this.items.filter(function (el) {
       return el.properties['opportunity:step'].id =='First Contact';
       });
       this.itemsProposal = this.items.filter(function (el) {
       return el.properties['opportunity:step'].id =='Proposal Sent';
       });
       this.itemsNegociation = this.items.filter(function (el) {
       return el.properties['opportunity:step'].id =='Negociation';
       });
       var i;
       for (i = 0; i < this.items.length; i++) {
          if(this.items[i].properties['opportunity:step'].id =='Limbo'){
          this.limboAmount+=this.items[i].properties['opportunity:amount'];
          }
          if(this.items[i].properties['opportunity:step'].id =='No go'){
          this.nogoAmount+=this.items[i].properties['opportunity:amount'];
          }
          if(this.items[i].properties['opportunity:step'].id =='Won'){
          this.wonAmount+=this.items[i].properties['opportunity:amount'];
          }
          if(this.items[i].properties['opportunity:step'].id =='Lost'){
          this.lostAmount+=this.items[i].properties['opportunity:amount'];
          }

           if(this.items[i].properties['opportunity:step'].id =='New'){
          this.newTotalAmount+=this.items[i].properties['opportunity:amount'];
          }
           if(this.items[i].properties['opportunity:step'].id =='First Contact'){
          this.firstContactTotalAmount+=this.items[i].properties['opportunity:amount'];
          }
           if(this.items[i].properties['opportunity:step'].id =='Proposal Sent'){
          this.proposalSentTotalAmount+=this.items[i].properties['opportunity:amount'];
          }
           if(this.items[i].properties['opportunity:step'].id =='Negociation'){
          this.negociationTotalAmount+=this.items[i].properties['opportunity:amount'];
          }
       }

       },

        _isItemsNull: function(items) {
         return items ? false : true;
       },
       _goToOpportunity:function(e){
        this.fire('navigate', {doc: (e.model || e.detail).item});
       },
      allowDrop:function(ev){
          ev.preventDefault();
          ev.currentTarget.classList.add('over');
      },
      allowDropFooter:function(ev){
          ev.preventDefault();
          ev.currentTarget.classList.add('footerDrop');
      },
      dragend:function(ev){
         ev.target.style.opacity = "";
         //this.$.top.scrollIntoView();

        // document.documentElement.style.setProperty('--empty-column-height', '500px');
        this.shadowRoot.querySelectorAll('.empty-column').forEach(function(emptyColumn){
          emptyColumn.style.height="";
          });
         this.$.new.hidden = false;
         this.$.first.hidden = false;
         this.$.proposal.hidden = false;
         this.$.nego.hidden = false;
         this.$.dropInNew.hidden = true;
         this.$.dropInFirst.hidden = true;
         this.$.dropInProposal.hidden = true;
         this.$.dropInNego.hidden = true;

        /* if ( ev.target.className == "empty-card over" ) {

            if(ev.target.offsetParent.firstElementChild.getAttribute("label")== "NEW"){
              for (var i=0; i < this.items.length; i++) {
                  if('id'+this.items[i].uid ==ev.target.id){
                    this.newTotalAmount-=this.items[i].properties['opportunity:amount'];
                  }
              }
            }
            if(ev.target.offsetParent.firstElementChild.getAttribute("label")== "FIRST CONTACT/DEMO"){
              for (var i=0; i < this.items.length; i++) {
                  if('id'+this.items[i].uid ==ev.target.id){
                    this.firstContactTotalAmount-=this.items[i].properties['opportunity:amount'];
                  }
              }
            }
            if(ev.target.offsetParent.firstElementChild.getAttribute("label")== "PROPOSAL SENT"){
              for (var i=0; i < this.items.length; i++) {
                  if('id'+this.items[i].uid ==ev.target.id){
                    this.proposalSentTotalAmount-=this.items[i].properties['opportunity:amount'];
                  }
              }
            }
            if(ev.target.offsetParent.firstElementChild.getAttribute("label")== "NEGOCIATION"){
              for (var i=0; i < this.items.length; i++) {
                  if('id'+this.items[i].uid ==ev.target.id){
                    this.negociationTotalAmount-=this.items[i].properties['opportunity:amount'];
                  }
              }
            }
        } */
      },
      dragenter:function(ev){
        if ( ev.target.className == "empty-column" ) {
          ev.target.style.backgroundColor = "rgb(0 0 0 / 20%)";
        }
      },
      dragLeave: function(ev){
          ev.preventDefault();
          if ( ev.target.className == "empty-column over" ) {
            ev.target.style.backgroundColor = "rgb(0 0 0 / 4%)";
          }
          ev.target.classList.remove('footerDrop');
          ev.target.classList.remove('over');
      },
      drag: function(ev){
        var dropColumnHg = (this.$.board.offsetHeight-38).toString()+"px";
        //var empty = document.querySelector( ".empty-column" );
        this.shadowRoot.querySelectorAll('.empty-column').forEach(function(emptyColumn){
          emptyColumn.style.height=dropColumnHg;
          });

        //empty.setProperty( "height", dropColumnHg );
        //document.documentElement.style.setProperty('--empty-column-height', dropColumnHg);
        /* this.customStyle['--empty-column-height'] = dropColumnHg;
          this.updateStyles(); */

        if (ev.target.parentNode.id === "new") {
          this.$.first.hidden = true;
          this.$.proposal.hidden = true;
          this.$.nego.hidden = true;
          this.$.dropInFirst.hidden = false;
          //this.$.dropInFirst.style.height = dropColumnHg;
          this.$.dropInProposal.hidden = false;
          //this.$.dropInProposal.style.height = dropColumnHg;
          this.$.dropInNego.hidden = false;
          //this.$.dropInNego.style.height = dropColumnHg;

        } else if (ev.target.parentNode.id === "first") {
          this.$.new.hidden = true;
          this.$.proposal.hidden = true;
          this.$.nego.hidden = true;
          this.$.dropInNew.hidden = false;
          //this.$.dropInNew.style.height = dropColumnHg;
          this.$.dropInProposal.hidden = false;
          //this.$.dropInProposal.style.height = dropColumnHg;
          this.$.dropInNego.hidden = false;
          //this.$.dropInNego.style.height = dropColumnHg;

        } else if (ev.target.parentNode.id === "proposal") {
          this.$.new.hidden = true;
          this.$.first.hidden = true;
          this.$.nego.hidden = true;
          this.$.dropInNew.hidden = false;
          //this.$.dropInNew.style.height = dropColumnHg;
          this.$.dropInFirst.hidden = false;
          //this.$.dropInFirst.style.height = dropColumnHg;
          this.$.dropInNego.hidden = false;
          //this.$.dropInNego.style.height = dropColumnHg;

        } else {
          this.$.new.hidden = true;
          this.$.first.hidden = true;
          this.$.proposal.hidden = true;
          this.$.dropInNew.hidden = false;
          //this.$.dropInNew.style.height = dropColumnHg;
          this.$.dropInFirst.hidden = false;
          //this.$.dropInFirst.style.height = dropColumnHg;
          this.$.dropInProposal.hidden = false;
          //this.$.dropInProposal.style.height = dropColumnHg;

        }
        ev.target.style.opacity = .5;
        ev.dataTransfer.setData("text",ev.target.id);
        ev.currentTarget.classList.add('dragging');
      },

      drop:function(ev){
          ev.preventDefault();
          var data=ev.dataTransfer.getData("text");
          if(ev.target.className === 'empty-column over'){
            ev.target.style.backgroundColor = "rgb(0 0 0 / 4%)";
            ev.target.appendChild(this.shadowRoot.querySelector('#'+data));
           // document.getElementById("emty")=ev.target.lastChild;
            ev.target.classList.remove('over');
            if(ev.target.parentNode.firstElementChild.getAttribute("label")== "NEW"){
              for (var i=0; i < this.items.length; i++) {
                if('id'+this.items[i].uid ==data){
                  this.newTotalAmount+=this.items[i].properties['opportunity:amount'];
                  this.document=this.items[i];
                  this._setStep('New',this.items[i].uid);
                }
              }
            }
            if(ev.target.parentNode.firstElementChild.getAttribute("label")== "FIRST CONTACT/DEMO"){
              for (var i = 0; i < this.items.length; i++) {
                if('id'+this.items[i].uid ==data){
                  this.firstContactTotalAmount+=this.items[i].properties['opportunity:amount'];
                  this.document=this.items[i];
                  this._setStep('First Contact',this.items[i].uid);
                }
              }
            }
            if(ev.target.parentNode.firstElementChild.getAttribute("label")== "PROPOSAL SENT"){
              for (var i = 0; i < this.items.length; i++) {
                if('id'+this.items[i].uid ==data){
                   this.proposalSentTotalAmount+=this.items[i].properties['opportunity:amount'];
                   this.document=this.items[i];
                   this._setStep('Proposal Sent',this.items[i].uid);
                }
              }
            }
            if(ev.target.parentNode.firstElementChild.getAttribute("label")== "NEGOCIATION"){
              for (var i = 0; i < this.items.length; i++) {
                if('id'+this.items[i].uid ==data){
                    this.negociationTotalAmount+=this.items[i].properties['opportunity:amount'];
                    this.document=this.items[i];
                    this._setStep('Negociation',this.items[i].uid);
                }
              }
            }
          }
           if(ev.target.localName === 'nuxeo-card' || ev.target.localName === 'qualitified-inline-edit'){
             //ev.target.parentNode.appendChild(this.shadowRoot.querySelector('#'+data));
             ev.target.parentNode.classList.remove('over');
          }
          this.shadowRoot.querySelector('#'+data).classList.remove('dragging');
          this.shadowRoot.querySelectorAll('over').forEach(function(drop){
            drop.classList.remove('over');
          });
            setTimeout(function(){
              let nuxeoApp = document.querySelector('nuxeo-app');
              var searchForm = nuxeoApp.$.drawer.querySelector('nuxeo-search-form[name="opportunity-list"');
                if(searchForm){
                  searchForm._search();
                }
            }, 500);
      },
      dropFooter: function(ev){
          ev.preventDefault();
          var data=ev.dataTransfer.getData("text");
          this.$.top.scrollIntoView();
          ev.target.classList.remove('footerDrop');
          var nuxeoApp = document.querySelector('nuxeo-app');
          var searchForm = nuxeoApp.$.drawer.querySelector('nuxeo-search-form[name="opportunity-list"');
          this.shadowRoot.querySelector('#new'+ev.target.id+'Amount').classList.add('slide');
          if(ev.target.id === 'limbo'){
          for (var i = 0; i < this.items.length; i++) {
              if('id'+this.items[i].uid ==data){
              this.newlimboAmount=this.items[i].properties['opportunity:amount'];
              this.document=this.items[i];
              this._setStep('Limbo',this.items[i].uid);
          }}
          this.limboAmount+=parseInt(this.newlimboAmount);
            setTimeout(function(){
              this.shadowRoot.querySelector('#newlimboAmount').classList.remove('slide');
              searchForm._search();
            }.bind(this),2000);
            this.shadowRoot.querySelector('#'+ev.target.id+'Amount').innerHTML=this._formatCurrency(this.limboAmount,this.currencyFormat,this.currency);
          }


          if(ev.target.id === 'nogo'){
          this.IdSelected=ev.target.parentNode.appendChild(this.shadowRoot.querySelector('#'+data));
          this.newnogoAmount=this.IdSelected.children[1].innerText.slice(0,10);
          for (var i = 0; i < this.items.length; i++) {
              if('id'+this.items[i].uid ==data){
              this.newnogoAmount=this.items[i].properties['opportunity:amount'];
              this.document=this.items[i];
              this._setStep('No go',this.items[i].uid);
          } }
          this.nogoAmount+=parseInt(this.newnogoAmount);
            setTimeout(function(){
              this.shadowRoot.querySelector('#newnogoAmount').classList.remove('slide');
              searchForm._search();
            }.bind(this),2000);
            this.shadowRoot.querySelector('#'+ev.target.id+'Amount').innerHTML=this._formatCurrency(this.nogoAmount,this.currencyFormat,this.currency);
          }


          if(ev.target.id === 'won'){
          this.IdSelected=ev.target.parentNode.appendChild(this.shadowRoot.querySelector('#'+data));
          for (var i = 0; i < this.items.length; i++) {
              if('id'+this.items[i].uid ==data){
              this.newwonAmount=this.items[i].properties['opportunity:amount'];
              this.document=this.items[i];
              this._setStep('Won',this.items[i].uid);
          } }
          this.wonAmount+=parseInt(this.newwonAmount);
            setTimeout(function(){
              this.shadowRoot.querySelector('#newwonAmount').classList.remove('slide');
              searchForm._search();
            }.bind(this),2000);
            this.shadowRoot.querySelector('#'+ev.target.id+'Amount').innerHTML=this._formatCurrency(this.wonAmount,this.currencyFormat,this.currency);
          }

          if(ev.target.id === 'lost'){
          this.IdSelected=ev.target.parentNode.appendChild(this.shadowRoot.querySelector('#'+data));
          for (var i = 0; i < this.items.length; i++) {
              if('id'+this.items[i].uid ==data){
               this.newlostAmount=this.items[i].properties['opportunity:amount'];
              this.document=this.items[i];
              this._setStep('Lost',this.items[i].uid);
          } }
          this.lostAmount+=parseInt(this.newlostAmount);
            setTimeout(function(){
              this.shadowRoot.querySelector('#newlostAmount').classList.remove('slide');
              searchForm._search();
            }.bind(this),2000);
            this.shadowRoot.querySelector('#'+ev.target.id+'Amount').innerHTML=this._formatCurrency(this.lostAmount,this.currencyFormat,this.currency);
          }

          this.shadowRoot.querySelector('#' + data).remove();
      },


      _setStep: function(value,inputID){
       this.params = {
                  xpath:"opportunity:step",
                  value:value,
                  save:true,
                  context: {},
                  input:inputID
                 };
            this.$.setProperty.execute();

       },

    _formatCurrency: function(val,format,currency) {
      if(val == null){
        return "";
      }
      return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, format)+' '+currency+'';
    },
    ready: async function () {
      const format = await this._getCurrencyFormat();
      this.currencyFormat = format;
      const curr = await this._getCurrency();
      this.currency = curr;
    },
     _getCurrencyFormat: async function(){
             let params = {};
             params.name = "CurrencyFormat";
             this.$.getOption.params = params;
             let result = await this.$.getOption.execute().then(function(response){
                 if(response === null){
                    return ",";
                 }else{
                    return response.value;
                 }
             }.bind(this));
             return result;
      },
     _getCurrency: async function(){
             let params = {};
             params.name = "Currency";
             this.$.getOption.params = params;
             let result = await this.$.getOption.execute().then(function(response){
                 if(response === null){
                    return "$";
                 }else{
                    return response.value;
                 }
             }.bind(this));
             return result;
      },

    });
  </script>
</dom-module>