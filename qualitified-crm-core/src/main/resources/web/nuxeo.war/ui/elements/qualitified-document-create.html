<dom-module id="qualitified-document-create" assetpath="nuxeo-document-actions/">
    <template>
        <style include="nuxeo-action-button-styles">
      .container {
        margin: 0;
        padding: 24px 0 0 0;
      }
      @media (min-width: 1024px) {
        nuxeo-dialog {
          min-width: 915px;
        }
      }
          paper-icon-button {
                padding: 0px;
                margin: -2px 6px;
                    flex: 0 1 auto;
                width: 22px;
                height: 22px;
                color: #c8c8c8a8;
            }
            .actions {
        @apply --buttons-bar;
        @apply --layout-horizontal;
        @apply --layout-flex;
        @apply --layout-justified;
      }

      .scrollable {
        padding: 0 24px;
        max-height: 60vh;
        @apply --layout-scroll;
      }
    </style>
        <nuxeo-operation id="create" input="/Marketing" op="Document.Create"></nuxeo-operation>

        <nuxeo-document id="doc" doc-id="[[document.uid]]" response="{{document}}" headers="[[headers]]" sync-indexing=""></nuxeo-document>
        <paper-icon-button icon="nuxeo:add" on-click="_create" ></paper-icon-button>

        <nuxeo-dialog id="dialog" no-auto-focus="" with-backdrop="" modal="">
            <div class="container">
                <iron-form id="form">
                    <form>
                        <div class="scrollable">
                            <nuxeo-document-layout id="layout" document="{{document}}" layout="[[layout]]"></nuxeo-document-layout>
                        </div>

                    </form>
                </iron-form>
                <div class="actions">
                    <paper-button dialog-dismiss="" noink="">[[i18n('command.cancel')]]</paper-button>
                    <paper-button id="save" on-tap="save" noink="" class="primary">[[i18n('command.save')]]</paper-button>
                </div>
            </div>

        </nuxeo-dialog>

    </template>
    <script>
    Polymer({
      is: 'qualitified-document-create',
      behaviors: [Nuxeo.I18nBehavior, Nuxeo.FiltersBehavior],
      properties: {
        /**
         * Input document.
         */
        document: {
          type: Object,
          notify: true
        },



        headers: {
          type: Object
        },

        type:{
            type:String
        },
        /**
         * Document form layout to load (default is `edit`)
         */
        layout: {
          type: String,
          value: 'edit'
        },
        /**
         * `true` if the action should display the label, `false` otherwise.
         */
        showLabel: {
          type: Boolean,
          value: false,
        },
        label: {
          type: String
        },
        icon: {
          type: String,
          value: 'nuxeo:edit'
        },

      },
       observers: [
        '_documentChanged(document.*)'
      ],
      /*get dialog() {
        return this.root.getElementById(this.layout + '-dialog');
      },
      get button() {
        return this.root.getElementById(this.layout + '-button');
      },*/
      _isAvailable: function(doc) {
        return doc && doc.type !== 'Root' && this.hasPermission(doc, 'Write') && this._isMutable(doc);
      },
      _isMutable: function(doc) {
        return doc && !this.hasFacet(doc, 'Immutable') && doc.type !== 'Root' && !this.isTrashed(doc);
      },
      _openDialog: function() {
        this.dialog.open();
      },
      _closeDialog: function() {
        var suggFieldTarget = this.parentNode.host;
        console.log(suggFieldTarget);
        suggFieldTarget.value=this.document.uid;
        this.$.dialog.close();
      },

      _create: function() {
         var op = this.$.create;
         op.params = {
           'type':this.type

         };
            return  op.execute().then(function(response) {
                this.document = response;
                let self = this;
                   timeout = setTimeout(function () {
                        self._toggleAddDialog();
                       }, 1000);
            }.bind(this));

       },
       _validate: function() {
        // run our custom validation function first to allow setting custom native validity
        var result = this.$.layout.validate() && this._doNativeValidation(this.$.form) && this.$.form.validate();
        if (result) {
          return result;
        } else {
          var layout = this.$.layout.$.layout;
          var nodes = layout._getValidatableElements(layout.element.root);
          var invalidField = nodes.find(function(node) {
            return node.invalid;
          });
          invalidField.scrollIntoView();
          invalidField.focus();
        }
      },

      _doSave: function() {
        if (!this.document.uid) { // create
          this.$.doc.data = this.document;
          return this.$.doc.post()
        } else { // edit
          this.$.doc.data = {
            'entity-type': 'document',
            uid: this.document.uid,
            properties: this._dirtyProperties
          };
          return this.$.doc.put();
        }
      },

      save: function() {
        if (!this._validate()) {
          return;
        }
        this._doSave().then(this._refresh.bind(this), function(err) {
          this.fire('notify', {message: this.i18n('document.saveError')});
          console.error(err);
        }.bind(this));
      },
      _refresh: function() {
      //  this.fire('document-updated');
      this.fire('notify', {message: 'Document created!'});
      this._closeDialog();
      },

      _documentChanged: function(e) {
        if (e.path === 'document') {
          this._dirtyProperties = {};
        } else {
          // copy dirty properties (cannot patch complex or list properties)
          var match = e.path.match(/^document\.properties\.([^\.]*)/);
          if (match) {
            var prop = match[1];
            this._dirtyProperties[prop] = this.document.properties[prop];
          }
        }
      },
      _toggleAddDialog: function () {
               this.$.dialog.toggle();
             },

      // trigger native browser invalid-form UI
      _doNativeValidation: function(/*form*/) {
        /*var fakeSubmit = document.createElement('input');
        fakeSubmit.setAttribute('type', 'submit');
        fakeSubmit.style.display = 'none';
        form._form.appendChild(fakeSubmit);
        fakeSubmit.click();
        form._form.removeChild(fakeSubmit);
        return form._form.checkValidity();*/
        return true;
      },

    });
  </script>
</dom-module>
