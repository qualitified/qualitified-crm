<dom-module id="qualitified-user-tag">
  <template>
    <style>
             nuxeo-user-avatar {
                margin: 0 .5rem 0 0;
            }
            nuxeo-tag {
                padding: 0 6px 0 0;
            }
            .tag {
                @apply --layout-horizontal;
                @apply --layout-center;
            }
            a {
                @apply --nuxeo-link;
            }
            a:hover {
                @apply --nuxeo-link-hover;
            }
        </style>
    <nuxeo-tag>
      <div class="tag">
        <nuxeo-user-avatar
                user="[[user]]"
                border-radius="50"
                height="22"
                width="22"
                font-size="10"
                font-weight="500"
                fetch-avatar\$="[[fetchAvatar]]">
        </nuxeo-user-avatar>
        <dom-if if="[[_hasLink(user)]]">
          <template>
            <a href$="[[_href(user)]]" on-click="_preventPropagation">[[_name(user)]]</a>
          </template>
        </dom-if>
        <dom-if if="[[!_hasLink(user)]]">
          <template>
            [[_name(user)]]
          </template>
        </dom-if>
        <!-- <dom-if if="[[_isEntity(user)]]">
          <template>
            <nuxeo-tooltip position="top" offset="0" animation-delay="0">
              [[_id(user)]]<br>[[_email(user)]]
            </nuxeo-tooltip>
          </template>
        </dom-if> -->
      </div>
    </nuxeo-tag>
  </template>
  <script>
    Polymer({
      is: 'qualitified-user-tag',
      behaviors: [
        Nuxeo.RoutingBehavior
      ],
       properties: {
        /**
         * User entity or a string
         */
         user: Object,
        /**
         * Disable link
         */
        disabled: {
            type: Boolean,
            value: false,
        },
        /**
         * Fetch avatar from profile if not already loaded.
         */
        fetchAvatar: {
            type: Boolean,
            value: false,
        },
      },
        _isEntity: function(user) {
            return user && user['entity-type'] && (user['entity-type'] === 'user'
                || (user['entity-type'] === 'document' && user.type === 'user')) && user.properties;
        },

        _id: function(user) {
            if (user) {
                const id = user.id || user.uid;
                return id || user.replace('user:', '');
            }
        },

        _name: function(user) {
            if (this._isEntity(user)) {
                const firstName = user.properties.firstName || user.properties['user:firstName'];
                const lastName = user.properties.lastName || user.properties['user:lastName'];
                const email = user.properties.email || user.properties['user:email'];
                return (firstName || lastName) ? `${firstName} ${lastName}` : email || this._id(user);
            } else {
                return this._id(user);
            }
        },

        _email: function(user) {
            if (this._isEntity(user)) {
                const email = user.properties.email || user.properties['user:email'];
                return email !== this._id(user) ? email : '';
            } else {
                return '';
            }
        },

        _href: function(user) {
            return this.urlFor('user', this._id(user));
        },

        _hasLink: function(user) {
            return !(this.disabled || (this._name(user) === 'system'));
        },

        /**
         * Prevents further propagation of the current event (for instance to avoid issues when the element is used
         * inside tables that add click events to the whole row).
         */
        _preventPropagation: function(e) {
            e.stopPropagation();
        }
    })
    </script>
</dom-module>