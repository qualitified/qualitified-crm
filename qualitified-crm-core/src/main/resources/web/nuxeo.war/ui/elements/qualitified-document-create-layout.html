<dom-module id="qualitified-document-create-layout" assetpath="document/">

  <template>
    <style include="iron-flex iron-flex-alignment nuxeo-styles">
      :host {
        display: block;
        @apply --layout-flex;
        @apply --layout-horizontal;
        --paper-dialog-scrollable: {
          padding: 0;
          overflow-x: hidden;
        };
      }

      paper-dialog-scrollable {
        display: block;
        @apply --layout-flex;
      }

      .typeSelection {
        margin: 1rem 0;
        @apply --layout-wrap;
        @apply --layout-flex;
        @apply --layout-horizontal;
      }

      .typeSelection paper-button {
        min-width: 128px;
        max-width: 128px;
        height: 128px;
        margin: 4px;
        border: none;
        text-align: center;
        box-shadow: none;
        background-color: var(--nuxeo-dialog-buttons-bar);
      }

      .typeSelection paper-button:hover {
        color: var(--nuxeo-link-hover-color);
        filter: brightness(102%);
        -webkit-filter: brightness(102%);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3), 0 -3px 0 var(--nuxeo-link-hover-color) inset;
      }

      .typeSelection iron-icon {
        width: var(--nuxeo-document-creation-form-icon-width, 42px);
        height: var(--nuxeo-document-creation-form-icon-height, 42px);
        filter: brightness(1.5);
        -webkit-filter: brightness(1.5);
      }

      .container {
        margin: 0 2rem;
        padding: 0 1rem 0 0;
        display: inline-block;
        @apply --layout-flex;
        @apply --layout-vertical;
      }

      #form {
        @apply --layout-flex;
        @apply --layout-horizontal;
      }

      #document-create {
        margin-bottom: 2.5em;
      }

      .heading {
        text-transform: uppercase;
        font-size: 1.1rem;
        padding: 1.7rem 2.5rem;
      }

      .heading iron-icon {
        width: 1.2rem;
        height: 1.2rem;
        margin-right: 8px;
      }

      .typeSelection div {
        margin-top: 1em;
        word-break: break-word;
      }

      .buttons {
        @apply --buttons-bar;
      }

      .error {
        border-left: 4px solid var(--nuxeo-warn-text);
        color: var(--nuxeo-text-default);
        padding-left: 8px;
      }

      .suggester {
        background-color: var(--nuxeo-dialog-buttons-bar);
        padding: 8px 16px;
        margin: 1rem 0;
        z-index: 100;
      }

      .importing-label {
        margin-right: 8px;
      }

      .vertical {
        @apply --layout-flex;
        @apply --layout-vertical;
      }

      iron-pages {
        @apply --layout-flex;
        @apply --layout-horizontal;
      }
    </style>

    <nuxeo-document id="docRequest" doc-path="[[targetPath]]" data="[[document]]" sync-indexing="" enrichers="permissions, subtypes" response="{{createResponse}}"></nuxeo-document>

    <iron-pages selected="edit" attr-for-selected="name">

      <div name="choose" class="vertical">
        <div class="container">
          <div class="suggester">
            <nuxeo-path-suggestion id="pathSuggesterChoose" value="{{targetPath}}" label="[[i18n('documentCreationForm.location')]]" parent="{{suggesterParent}}" children="{{suggesterChildren}}" disabled="" always-float-label=""></nuxeo-path-suggestion>
            <span class$="horizontal layout [[_formatErrorMessage(errorMessage)]]">​[[errorMessage]]</span>
          </div>
          <paper-dialog-scrollable>
            <div name="typeSelection" class="typeSelection">
              <template is="dom-repeat" items="[[subtypes]]" as="type">
                <paper-button noink="" name$="[[type.type]]" class="docTypeButton vertical layout" on-tap="_selectType" data-args$="[[type]]">
                  <iron-icon src="[[_getTypeIcon(type)]]"></iron-icon>
                  <div>[[_getTypeLabel(type)]]</div>
                </paper-button>
              </template>
            </div>
          </paper-dialog-scrollable>
        </div>
        <div class="buttons horizontal end-justified layout">
          <div class="flex start-justified">
            <paper-button noink="" dialog-dismiss="" on-tap="_cancel">[[i18n('command.cancel')]]</paper-button>
          </div>
        </div>
      </div>

      <div name="edit" class="vertical layout flex">
        <div class="horizontal layout heading center">
          <iron-icon src="[[_getTypeIcon(selectedDocType)]]"></iron-icon>

          <span>[[_newDocumentLabel(selectedDocType)]]</span>
        </div>
        <div id="editor" class="container">
          <div class="suggester">
            <nuxeo-path-suggestion id="pathSuggesterEdit" value="{{targetPath}}" label="[[i18n('documentCreationForm.location')]]" parent="{{suggesterParent}}" children="{{suggesterChildren}}" disabled="" always-float-label=""></nuxeo-path-suggestion>
            <span class$="horizontal layout [[_formatErrorMessage(errorMessage)]]">​[[errorMessage]]</span>
          </div>
          <paper-dialog-scrollable id="editScrollable">
            <iron-form id="form">
              <form class="form vertical layout flex">
                <iron-a11y-keys keys="enter" on-keys-pressed="_submitKeyHandler"></iron-a11y-keys>
                <nuxeo-document-layout id="document-create" layout="create" document="[[document]]"></nuxeo-document-layout>
              </form>
            </iron-form>
          </paper-dialog-scrollable>
        </div>
        <div class="buttons horizontal end-justified layout">
          <div class="flex start-justified">
            <paper-button noink="" dialog-dismiss="" on-tap="_cancel" disabled$="[[creating]]">[[i18n('command.cancel')]]</paper-button>
          </div>

          <paper-button id="create" noink="" class="primary" on-tap="_create" disabled$="[[!_canCreate(canCreate,creating)]]">
            <template is="dom-if" if="[[!creating]]">
              [[i18n('command.create')]]
            </template>
            <template is="dom-if" if="[[creating]]">
              <span class="importing-label">[[i18n('documentImport.creating')]]</span>
              <paper-spinner-lite active=""></paper-spinner-lite>
            </template>
          </paper-button>
        </div>
      </div>

    </iron-pages>

    <nuxeo-document-creation-stats id="creationStats"></nuxeo-document-creation-stats>

  </template>

  <script>
    Polymer({
      is: 'qualitified-document-create-layout',
      behaviors: [Polymer.IronResizableBehavior, Nuxeo.DocumentCreationBehavior],
      properties: {

        createdDocument:{
          type: Object
        },
        stage: {
          type: String,
          value: 'choose'
        },

        visible: {
          type: Boolean
        },

        creating: {
          type: Boolean,
          value: false
        },
        selectedDocType:{
            type:Object
          },

      },

      observers: [
        '_visibleOnStage(visible,stage)'
      ],

      ready: function() {
        this.addEventListener('element-changed', this._layoutUpdated.bind(this), true);
      },

       init: function(docTypeObj) {
        if (docTypeObj) {
            this.selectedDocType = docTypeObj;
          }
      },

      /**
       * Retrieves and creates the layout for the current document type
       */
      _updateDocument: function() {

        if (!this._isValidType(this.selectedDocType) || !this.parent) {
          this.document = null;
          return;
        }
        this.newDocument(this.selectedDocType.type, this._getDocumentProperties()).then(function(document) {
          document.parentRef = this.parent.uid;
          this.document = document;
          this.stage = 'edit';
          this.$.editScrollable.scrollTarget.scrollTop = 0;
        }.bind(this));
      },

      _selectType: function(e) {
        this.selectedDocType = e.model.type;
        this.fire('nx-creation-wizard-hide-tabs');
      },
      _getTypeIcon :function(selectedDocType){
         return selectedDocType.id  ? "images/doctypes/"+selectedDocType.id+".svg" : "";
      },
      _validate: function() {
        var layout = this.$['document-create'];
        var result = layout.validate() && this._doNativeValidation(this.$.form) &&
          this.$.form.validate() && this._isValidType(this.selectedDocType);
        if (result) {
          return result;
        } else {
          var innerLayout = layout.$.layout;
          var nodes = innerLayout._getValidatableElements(innerLayout.element.root);
          var invalidField = nodes.find(function(node) {
            return node.invalid;
          });
          invalidField.scrollIntoView();
          invalidField.focus();
        }
      },

      _create: function() {
        if (!this._validate() || !this.canCreate) {
          return;
        }
        this.document.name = this.document.name || this._sanitizeName(this.document.properties['dc:title']);
        this.set('creating', true);
        this.$.docRequest.post().then(function(response) {
          this.$.creationStats.storeType(this.selectedDocType.id);
          this._clear();
          //this.navigateTo('browse', response.path);
         // window.open("#!/browse"+response.path);
          this.createdDocument=response;
          this.document=undefined;
          this._notify(response);
          this.set('creating', false);
        }.bind(this)).catch(function(err) {
          this.set('creating', false);
          this.fire('notify', {message: this.i18n('documentCreationForm.createError')});
          console.error(err);
        }.bind(this));

      },

      _back: function() {
        this._clear();
        this.fire('nx-creation-wizard-show-tabs');
      },

      _cancel: function() {
        this._clear();
        this.document = undefined;
        //this.fire('nx-creation-wizard-show-tabs');
      },

      _newDocumentLabel: function() {
        return this.i18n('documentCreationForm.newDoc.heading', this.selectedDocType.type);
      },

      _clear: function() {
        //this.stage = 'choose';
        this.selectedDocType = {};
      },

      _visibleOnStage: function() {
        this.$.pathSuggesterChoose.disabled = !this.visible || this.stage !== 'choose';
        this.$.pathSuggesterEdit.disabled = !this.visible || this.stage !== 'edit';
      },

      _layoutUpdated: function(e) {
        this.async(function() {
          var input = e.detail.value.querySelector('[autofocus]');
          if (input) {
              console.log(input);
            input.focus();
          }
        });
      },

      _submitKeyHandler: function(e) {
        if (e.detail.keyboardEvent.target.tagName === 'INPUT') {
          this._create();
        }
      },

      _canCreate: function() {
        return this.canCreate && !this.creating;
      },

      // trigger native browser invalid-form UI
      _doNativeValidation: function(/*form*/) {
        var fakeSubmit = document.createElement('input');
        fakeSubmit.setAttribute('type', 'submit');
        fakeSubmit.style.display = 'none';
        // TODO: this breaks fields bound to multivalued nuxeo-directory-suggestion
        /* form._form.appendChild(fakeSubmit);
        fakeSubmit.click();
        form._form.removeChild(fakeSubmit);
        return form._form.checkValidity(); */
        return true;
      }

    });
  </script>
</dom-module>