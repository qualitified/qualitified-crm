<link rel="import" href="qualitified-amount.html">
<link rel="import" href="qualitified-user-suggestion.html">
<link rel="import" href="qualitified-user-tag.html">


<dom-module id="qualitified-inline-edit">
    <template>
        <style include="nuxeo-styles">
            *[role=widget] {
                padding: 5px;
            }
            paper-icon-button {
                padding: 0px;
                margin: -2px 6px;
                flex: 0 1 auto;
                width: 22px;
                height: 22px;
                color: #c8c8c8a8;
            }
            .labelAction {
                display: inline-flex;
            }
            .iconNavigate {
                display: inline-flex;
                float:right;
            }
            .iconsAction {
                display: inline-flex;
                float:right;
            }
            .expired-date {
                color:#fd2727a8;
            }
            .notify {
                font-size: 50%;
                color: red;
                margin-left: 3px;
            }
            .input {
                overflow: hidden;
                text-overflow: ellipsis;
            }
            div.multiline {
                white-space: pre-line;
            }
        </style>
        <nuxeo-operation id="setProperty" op="Document.SetProperty" input="[[document]]" params="[[params]]"></nuxeo-operation>
        <nuxeo-operation id="updateDoc" op="Document.Update" input="[[document]]" params="[[params]]"></nuxeo-operation>

        <paper-toast id="inlineToast"></paper-toast>
        <!-- View -->
        <div id="view" hidden$="[[edit]]" on-mouseover="_show" on-mouseout="_hide">
            <div class="labelAction">
                <label>[[i18n(label)]]</label>
                <paper-icon-button id="editButton" icon="icons:create" hidden$="[[!show]]" on-tap="_editMode">
                </paper-icon-button>
            </div>
            <div class="iconNavigate">
                <paper-icon-button hidden$="[[!isLink]]" icon="icons:open-in-new" on-tap="_navigate"></paper-icon-button>
            </div>
            <br/>
            <template is="dom-if" if="[[_isInput(metadata)]]">
                <div class="input">[[_getFormattedValue(value)]]</div>
            </template>
            <template is="dom-if" if="[[_isAmount(metadata)]]">
                <qualitified-amount value="{{value}}">
                </qualitified-amount>
            </template>
            <template is="dom-if" if="[[_isText(metadata)]]">
                <div class="multiline">[[value]]</div>


            </template>
            <template is="dom-if" if="[[_isLink(metadata)]]">
                <u><a href="[[value]]"style="color:blue;">[[value]]</a></u>
            </template>
            <template is="dom-if" if="[[_isDirectory(metadata)]]">
                [[formatDirectory(value)]]
            </template>
            <template id="dateField" is="dom-if" if="[[_isDate(metadata)]]">
                <div style="[[_getStyle(value)]]">[[formatDate(value)]]</div>
            </template>
            <template is="dom-if" if="[[_isUser(metadata)]]">
                <div style="margin-top: 5px;">
                    <qualitified-user-tag user="{{value}}">
                    </qualitified-user-tag>
                </div>
            </template>
            <template is="dom-if" if="[[_isUsers(metadata)]]">
                <div style="margin-top: 5px;">
                    <template is="dom-repeat" items="[[value]]">
                        <qualitified-user-tag user="[[item]]">
                        </qualitified-user-tag>
                    </template>
                </div>
            </template>
            <template is="dom-if" if="[[_isDocument(metadata)]]">
                <qualitified-document-suggestion role="widget"
                                                 value="{{value}}"
                                                 page-provider="documents"
                                                 document="[[document]]"
                                                 min-chars="0"
                                                 display-style="viewInlineStyle"
                                                 multiple="[[multiple]]"
                                                 clickable="[[clickable]]"
                                                 readonly
                                                 id="inlineSugst">
                </qualitified-document-suggestion>
            </template>
        </div>
        <!-- Edit -->
        <div id="edit" hidden$="[[!edit]]">
            <div class="labelAction">
                <label>[[i18n(label)]]</label>
            </div>
            <div hidden$="[[displayButtons]]" class="iconsAction">
                <template is="dom-if" if="[[_isAddable(metadata,addable)]]">
                    <qualitified-document-create style="margin-right:-14px;"
                                                             create-from="metadata-layout"
                                                             document="[[document]]"
                                                             parent-to-select="[[parentToSelect]]"
                                                             type="[[_getSuggType(params)]]">
                    </qualitified-document-create>
                </template>
                <paper-icon-button style="left:8px;" icon="icons:save" on-tap="_update"></paper-icon-button>
                <paper-icon-button icon="icons:close" on-tap="_cancel"></paper-icon-button>
            </div>
            <template is="dom-if" if="[[_isInput(metadata)]]">
                <nuxeo-input role="widget"
                             value="{{newValue}}"
                             type="text">
                </nuxeo-input>
            </template>
            <template is="dom-if" if="[[_isAmount(metadata)]]">
                <nuxeo-input role="widget"
                             value="{{newValue}}"
                             type="text">
                </nuxeo-input>
            </template>
            <template is="dom-if" if="[[_isText(metadata)]]">
                <nuxeo-textarea role="widget"
                                value="{{newValue}}"
                                type="text">
                </nuxeo-textarea>
            </template>
            <template is="dom-if" if="[[_isLink(metadata)]]">
                <nuxeo-textarea role="widget"
                                value="{{newValue}}"
                                type="text">
                </nuxeo-textarea>
            </template>
            <template is="dom-if" if="[[_isDirectory(metadata)]]">
                <nuxeo-directory-suggestion role="widget"
                                            value="{{newValue}}"
                                            type="text"
                                            directory-name="[[directory]]"
                                            min-chars="0">
                </nuxeo-directory-suggestion>
            </template>
            <template is="dom-if" if="[[_isDate(metadata)]]">
                <nuxeo-date-picker role="widget"
                                   value="{{newValue}}"
                                   type="text"
                                   directory-name="[[directory]]"
                                   min-chars="0">
                </nuxeo-date-picker>
            </template>
            <template is="dom-if" if="[[_isUser(metadata)]]">
                <qualitified-user-suggestion id="userId"
                                             role="widget"
                                             value="{{newValue}}"
                                             search-type="USER_TYPE"
                                             min-chars="0">
                </qualitified-user-suggestion>
            </template>
            <template is="dom-if" if="[[_isUsers(metadata)]]">
                <qualitified-user-suggestion id="userId"
                                             role="widget"
                                             value="{{newValue}}"
                                             search-type="USER_TYPE"
                                             multiple="[[multiple]]"
                                             min-chars="0">
                </qualitified-user-suggestion>
            </template>
            <template is="dom-if" if="[[_isDocument(metadata)]]">
               <qualitified-document-suggestion role="widget"
                                       id="inlineSugst"
                                       value="{{newValue}}"
                                       page-provider="documents"
                                       multiple="[[multiple]]"
                                       display-style="editInlineStyle"
                                       min-chars="0"
                                       params="{{params}}">
              </qualitified-document-suggestion>
            </template>
            <div hidden$="[[!displayButtons]]" class="buttons">
                <paper-button noink dialog-dismiss on-tap="_cancel">Cancel</paper-button>
                <paper-button noink dialog-confirm class="primary" on-tap="_update">Save</paper-button>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'qualitified-inline-edit',
            behaviors: [Nuxeo.LayoutBehavior,Nuxeo.RoutingBehavior,Nuxeo.FormatBehavior],
            properties: {
                document: {
                    type: Object,
                    observer: '_documentChanged'
                },
                edit: {
                    type: Boolean,
                    value: false
                },
                label:{
                    type: String,
                    value: 'label.dublincore.title'
                },
                required:{
                    type: Boolean,
                    value: false
                },
                multiple:{
                    type: Boolean,
                    value: false
                },
                addable:{
                    type: Boolean,
                    value: false
                },
                clickable:{
                    type: Boolean,
                    value: false
                },
                displayButtons:{
                    type: Boolean,
                    value: false
                },
                property:{
                    type: String,
                    value:'dc:title',
                    observer: '_propertyChanged'
                },
                suggestionType: {
                    type: String,
                    value: ''
                },
                parentToSelect: {
                    type: String,
                },
                parentProviders: {
                    type: Array,
                    value: []
                },
                value:{
                    type: String,
                    value: '',
                    observer: '_valueChanged'
                },
                newValue:{
                    type: String,
                    value: ''
                },
                toBeFormatted:{
                    type: Boolean,
                    value: false
                },
                formatResolver:{
                    type: String,
                    value: ''
                },
                valueFormatter:{
                    type: Function,
                    value: ''
                },
                option1:{
                    type: String,
                    value: ''
                },
                option2:{
                    type: String,
                    value: ''
                },
                option3:{
                    type: String,
                    value: ''
                },
                option4:{
                    type: String,
                    value: ''
                },
                params:{
                    type: Object,
                    value: {}
                },
                isLink: {
                    type: Boolean,
                    value: false
                },
                notifyValue: {
                    type: Boolean,
                    value: false
                },
                show: {
                    type: Boolean,
                    value: false
                },
                metadata:{
                    type: String,
                    value: 'input'
                },
                directory:{
                    type: String,
                    value: ''
                },
                namedParameters:{
                    type: String,
                    value: ''
                },
                dateStyle:{
                    type: String,
                    value: ''
                }
            },

            ready(){
                if (this.formatResolver) {
                    //new function to formate the displayed value, must have value as input and options props as variables.
                    //formatResolver is a string as value formatter.
                    this.valueFormatter = new Function("value","return" + " " +this.formatResolver);
                }
            },
            _typeObserver:function() {
                if (this.$.inlineSugst){
                this.searchingType = this.$.inlineSugst.suggestionType;
                }
             //return type;
            },
            _valueChanged: function(value) {
                if(this.value && this.document && this.document.properties){
                    this.document.properties[this.property] = this.value;
                }
            },
            _documentChanged: function() {
                if (this.document) {
                    this.value = this.document.properties[this.property];
                    this.edit = false;
                }
            },
            _editMode: function() {
                this.newValue = this.value;
                this.edit = true
            },
            _isMutable: function(doc) {
                var mutable = !this.hasFacet(doc, 'Immutable') && doc.type !== 'Root' && doc.state !== 'deleted';
                return mutable;
            },
            _canEdit: function(doc, edit) {
                return true;
                //var canEdit = !edit && doc && doc.type !== 'Root' && this.hasPermission(doc, 'Write') && this._isMutable(doc);
                //return canEdit;
            },
            _update: function (){
               if (this.multiple === true) {
                 this._updateProperties();
               } else {
                 this._updateProperty();
               }

            },
            _updateProperty: function() {
                this.value = this.newValue;
                this.$.setProperty.params = {
                    xpath:this.property,
                    value:this.value,
                    save:true,
                    context: {},
                    input: this.document.uid
                };

                this.$.setProperty.execute().then(function(response){
                    //this.fire('document-updated');
                    this.$.inlineToast.text = "Update done!";
                    this.$.inlineToast.open();
                    this.edit = false;
                    var self = this;
                    setTimeout(function () {
                      self._fetchProviders();
                    }, 1500);
                }.bind(this))
                    .catch(function (error){
                        console.log(error);
                        this.$.inlineToast.text = "Error when updating...";
                        this.$.inlineToast.open();
                    }.bind(this));
            },
            _updateProperties: function() {
                this.value = this.newValue;
                const xpath = this.property;
                var props = new Object;
                props[xpath] = this.value;
                this.$.updateDoc.params = {
                    properties:props,
                    save:true,
                    context: {},
                    input: this.document.uid
                };

                this.$.updateDoc.execute().then(function(response){
                    //this.fire('document-updated');
                    this.$.inlineToast.text = "Update done!";
                    this.$.inlineToast.open();
                    this.edit = false;
                    var self = this;
                    setTimeout(function () {
                      self._fetchProviders();
                    }, 1500);
                }.bind(this))
                    .catch(function (error){
                        console.log(error);
                        this.$.inlineToast.text = "Error when updating...";
                        this.$.inlineToast.open();
                    }.bind(this));
            },
            _getSuggType: function(params){
                return params.namedParameters.split("=").pop();
            },
            _fetchProviders: function() {
               if (this.parentProviders && this.parentProviders.length>0){
                this.parentProviders.forEach( provider => {
                    this.parentNode.parentNode.parentNode.host.shadowRoot.getElementById(provider).fetch();
                })
              }
            },
            _isExpiredDate :function(value) {
                var currentDate = new Date();
                if (value && this.notifyValue &&  (currentDate.toISOString() < value) ) {
                    return "closed";
                } else return "";
            },
            _getStyle :function(value) {
                var currentDate = new Date();
                if (value && this.notifyValue &&  (currentDate.toISOString() > value) ) {
                    return  "color:#fd2727a8;";
                } return "";
            },
            _propertyChanged: function() {
              this.$.view.style = (this.property && this.property.includes('custom:document')==true) ? "margin-left: 6px ": "";
              this.$.edit.style = (this.property && this.property.includes('custom:document')==true) ? "margin-left: 6px ": "";
            },
            //formats the displayed value by excuting the received function from the parent
            _getFormattedValue: function(value) {
                if (value && this.toBeFormatted) {
                    return this.valueFormatter(value);
                } else return value;
            },
            _isAddable: function(metadata,addable){
               return metadata && metadata == 'document' && addable == true;
            },
            _navigate: function(e) {
                var oppListResults = document.querySelector("body > nuxeo-app").shadowRoot.querySelector("#searchResults").shadowRoot.querySelector("nuxeo-page > div.content > nuxeo-results-view").shadowRoot.querySelector("#results").shadowRoot.querySelector("#results").shadowRoot.querySelector("#container > nuxeo-opportunity_list-search-results").opportunityList;
                var itemToNavigateIndex = oppListResults.map(function(e) {
                     return e.uid;
                }).indexOf(this.document.uid);
                this.fire('navigate', { doc: this.document, index: itemToNavigateIndex});
            },
            _cancel: function(){
                this.newValue = this.value;
                this.edit = false;
            },
            _show: function(){
                this.show = true;
            },
            _hide: function(){
                this.show = false;
            },
            _isInput: function(value){
                return value && value == 'input';
            },
            _isText: function(value){
                return value && value == 'textarea';
            },
            _isDirectory: function(value){
                return value && value == 'directory';
            },
            _isDate: function(value){
                return value && value == 'date';
            },
            _isUser: function(value){
                return value && value == 'user' && this.multiple == false;
            },
            _isUsers: function(value){
                return value && value == 'user' && this.multiple == true;
            },
            _isDocument: function(value){
                return value && value == 'document';
            },
            _isLink: function(value){
                return value && value == 'link';
            },
            _isAmount:function(value){
                return value && value == 'amount';
            }
        });
    </script>
</dom-module>